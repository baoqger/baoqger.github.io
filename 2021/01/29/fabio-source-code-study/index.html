<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Fabio source code study part 1 | Chris Bao&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="BackgroundIn this two-part blog series, I want to share the lessons learned from reading the soruce code of the project Fabio. In my previous blog, I shared with you how to use Fabio as a load balanci">
<meta property="og:type" content="article">
<meta property="og:title" content="Fabio source code study part 1">
<meta property="og:url" content="https://baoqger.github.io/2021/01/29/fabio-source-code-study/index.html">
<meta property="og:site_name" content="Chris Bao&#39;s Blog">
<meta property="og:description" content="BackgroundIn this two-part blog series, I want to share the lessons learned from reading the soruce code of the project Fabio. In my previous blog, I shared with you how to use Fabio as a load balanci">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://baoqger.github.io/images/fabio.png">
<meta property="article:published_time" content="2021-01-29T14:09:56.000Z">
<meta property="article:modified_time" content="2021-12-23T12:34:34.791Z">
<meta property="article:author" content="Chris Bao">
<meta property="article:tag" content="Fabio, Golang, Source code">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://baoqger.github.io/images/fabio.png">
  
    <link rel="alternate" href="/atom.xml" title="Chris Bao&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Chris Bao&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
          <a class="main-nav-link" href="/project">Project</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://baoqger.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-fabio-source-code-study" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/01/29/fabio-source-code-study/" class="article-date">
  <time datetime="2021-01-29T14:09:56.000Z" itemprop="datePublished">2021-01-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Fabio source code study part 1
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h3><p>In this two-part blog series, I want to share the lessons learned from reading the soruce code of the project <code>Fabio</code>. In my previous blog, I shared with you how to use Fabio as a load balancing in the micro services applicatoins, in detail you can refer to this <a href="https://baoqger.github.io/2020/12/30/golang-load-balancing-fabio/">article</a>.  </p>
<p>Since <code>Fabio</code> is not a tiny project, it’s hard to cover everything inside this project. I will mainly focus on two aspects: firstly in the <strong>architecture design  level</strong>, I will study how it can work as a load balancer without any configuration file (Part one), and secondly in the <strong>language level</strong>, I want to summarize the best practice of writing Golang programs by investigating which features of Golang it uses and how it uses (Part two). </p>
<h3 id="Fabio-architecture-design"><a href="#Fabio-architecture-design" class="headerlink" title="Fabio architecture design"></a>Fabio architecture design</h3><p>Let’s start by introducing some background about Fabio. Following paragraph is from its official document: </p>
<blockquote>
<p>Fabio is an HTTP and TCP reverse proxy that configures itself with data from Consul. Traditional load balancers and reverse proxies need to be configured with a config file. </p>
</blockquote>
<p>If you’re familiar with other load balancer service such as <code>Nginx</code>, it will be easy for you to understand how Fabio is different and why it seems interestring. </p>
<p>For example, if you’re using <code>Nginx</code> as your load balancer, you need to maintain a config file where the routing rules need to be defined as below </p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span> /data/www;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> /images/ &#123;</span><br><span class="line">        <span class="attribute">root</span> /data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>But Fabio is a zero-conf load balancer. Cool, right? Let’s review the design and code to uncover the secrets under the hood. </p>
<p><img src="/images/fabio.png" alt="load-balancing"></p>
<p>Simply speaking, Fabio’s design can be divided into two parts: <strong>Consul monitor</strong> and <strong>proxy</strong>. Consul monitor forms and updates a <code>route table</code> by watching the data stored in Consul, and proxy distributes the request to target service instance based on the <code>route table</code>.</p>
<h4 id="main-function"><a href="#main-function" class="headerlink" title="main function"></a>main function</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	logOutput := logger.NewLevelWriter(os.Stderr, <span class="string">&quot;INFO&quot;</span>, <span class="string">&quot;2017/01/01 00:00:00 &quot;</span>)</span><br><span class="line">	log.SetOutput(logOutput)</span><br><span class="line"></span><br><span class="line">	cfg, err := config.Load(os.Args, os.Environ())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		exit.Fatalf(<span class="string">&quot;[FATAL] %s. %s&quot;</span>, version, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> cfg == <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(version)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	log.Printf(<span class="string">&quot;[INFO] Setting log level to %s&quot;</span>, logOutput.Level())</span><br><span class="line">	<span class="keyword">if</span> !logOutput.SetLevel(cfg.Log.Level) &#123;</span><br><span class="line">		log.Printf(<span class="string">&quot;[INFO] Cannot set log level to %s&quot;</span>, cfg.Log.Level)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	log.Printf(<span class="string">&quot;[INFO] Runtime config\n&quot;</span> + toJSON(cfg))</span><br><span class="line">	log.Printf(<span class="string">&quot;[INFO] Version %s starting&quot;</span>, version)</span><br><span class="line">	log.Printf(<span class="string">&quot;[INFO] Go runtime is %s&quot;</span>, runtime.Version())</span><br><span class="line"></span><br><span class="line">	WarnIfRunAsRoot(cfg.Insecure)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> prof <span class="keyword">interface</span> &#123;</span><br><span class="line">		Stop()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> cfg.ProfileMode != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> mode <span class="function"><span class="keyword">func</span><span class="params">(*profile.Profile)</span></span></span><br><span class="line">		<span class="keyword">switch</span> cfg.ProfileMode &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;&quot;</span>:</span><br><span class="line">			<span class="comment">// do nothing</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;cpu&quot;</span>:</span><br><span class="line">			mode = profile.CPUProfile</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;mem&quot;</span>:</span><br><span class="line">			mode = profile.MemProfile</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;mutex&quot;</span>:</span><br><span class="line">			mode = profile.MutexProfile</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;block&quot;</span>:</span><br><span class="line">			mode = profile.BlockProfile</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;trace&quot;</span>:</span><br><span class="line">			mode = profile.TraceProfile</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			log.Fatalf(<span class="string">&quot;[FATAL] Invalid profile mode %q&quot;</span>, cfg.ProfileMode)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		prof = profile.Start(mode, profile.ProfilePath(cfg.ProfilePath), profile.NoShutdownHook)</span><br><span class="line">		log.Printf(<span class="string">&quot;[INFO] Profile mode %q&quot;</span>, cfg.ProfileMode)</span><br><span class="line">		log.Printf(<span class="string">&quot;[INFO] Profile path %q&quot;</span>, cfg.ProfilePath)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	exit.Listen(<span class="function"><span class="keyword">func</span><span class="params">(s os.Signal)</span></span> &#123;</span><br><span class="line">		atomic.StoreInt32(&amp;shuttingDown, <span class="number">1</span>)</span><br><span class="line">		proxy.Shutdown(cfg.Proxy.ShutdownWait)</span><br><span class="line">		<span class="keyword">if</span> prof != <span class="literal">nil</span> &#123;</span><br><span class="line">			prof.Stop()</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> registry.Default == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		registry.Default.DeregisterAll()</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	initMetrics(cfg)</span><br><span class="line">	initRuntime(cfg)</span><br><span class="line">	initBackend(cfg)</span><br><span class="line"></span><br><span class="line">	trace.InitializeTracer(&amp;cfg.Tracing)</span><br><span class="line"></span><br><span class="line">	startAdmin(cfg)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> watchNoRouteHTML(cfg)</span><br><span class="line"></span><br><span class="line">	first := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>)</span><br><span class="line">	<span class="keyword">go</span> watchBackend(cfg, first)</span><br><span class="line">	log.Print(<span class="string">&quot;[INFO] Waiting for first routing table&quot;</span>)</span><br><span class="line">	&lt;-first</span><br><span class="line"></span><br><span class="line">	startServers(cfg)</span><br><span class="line"></span><br><span class="line">	WarnIfRunAsRoot(cfg.Insecure)</span><br><span class="line"></span><br><span class="line">	exit.Wait()</span><br><span class="line">	log.Print(<span class="string">&quot;[INFO] Down&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The <code>main</code> function defines Fabio’s workflow. To understand how Fabio works, we only need to focus on three points: </p>
<ul>
<li><strong>initBackend()</strong> and <strong>watchBackend()</strong>: these two functions contain Consul monitoring logic. </li>
<li><strong>startServers()</strong>: this function is responsible to create the network proxy.</li>
</ul>
<h4 id="Consul-monitoring"><a href="#Consul-monitoring" class="headerlink" title="Consul monitoring"></a>Consul monitoring</h4><p>First, let’s review the <code>initBackend</code> function: </p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initBackend</span><span class="params">(cfg *config.Config)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> deadline = time.Now().Add(cfg.Registry.Timeout)</span><br><span class="line">	<span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">switch</span> cfg.Registry.Backend &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;file&quot;</span>:</span><br><span class="line">			registry.Default, err = file.NewBackend(&amp;cfg.Registry.File)</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;static&quot;</span>:</span><br><span class="line">			registry.Default, err = static.NewBackend(&amp;cfg.Registry.Static)</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;consul&quot;</span>:</span><br><span class="line">			registry.Default, err = consul.NewBackend(&amp;cfg.Registry.Consul)</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;custom&quot;</span>:</span><br><span class="line">			registry.Default, err = custom.NewBackend(&amp;cfg.Registry.Custom)</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			exit.Fatal(<span class="string">&quot;[FATAL] Unknown registry backend &quot;</span>, cfg.Registry.Backend)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err = registry.Default.Register(<span class="literal">nil</span>); err == <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		log.Print(<span class="string">&quot;[WARN] Error initializing backend. &quot;</span>, err)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> time.Now().After(deadline) &#123;</span><br><span class="line">			exit.Fatal(<span class="string">&quot;[FATAL] Timeout registering backend.&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		time.Sleep(cfg.Registry.Retry)</span><br><span class="line">		<span class="keyword">if</span> atomic.LoadInt32(&amp;shuttingDown) &gt; <span class="number">0</span> &#123;</span><br><span class="line">			exit.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This function is not hard to understand. Fabio supports various modes: <code>file</code>, <code>static</code>, <code>consul</code> and <code>custom</code>, and will select one mode to use based on the detailed condition inside the <code>cfg</code> parameter. In our case, we only need to focus on the <code>consul</code> mode. </p>
<p>Next let’s review <code>watchBackend()</code> function to check how it keeps watching consul’s data.</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">watchBackend</span><span class="params">(cfg *config.Config, first <span class="keyword">chan</span> <span class="type">bool</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		nextTable   <span class="type">string</span></span><br><span class="line">		lastTable   <span class="type">string</span></span><br><span class="line">		svccfg      <span class="type">string</span></span><br><span class="line">		mancfg      <span class="type">string</span></span><br><span class="line">		customBE    <span class="type">string</span></span><br><span class="line">		once        sync.Once</span><br><span class="line">		tableBuffer = <span class="built_in">new</span>(bytes.Buffer) <span class="comment">// fix crash on reset before used (#650)</span></span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> cfg.Registry.Backend &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;custom&quot;</span>:</span><br><span class="line">		svc := registry.Default.WatchServices()</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			customBE = &lt;-svc</span><br><span class="line">			<span class="keyword">if</span> customBE != <span class="string">&quot;OK&quot;</span> &#123;</span><br><span class="line">				log.Printf(<span class="string">&quot;[ERROR] error during update from custom back end - %s&quot;</span>, customBE)</span><br><span class="line">			&#125;</span><br><span class="line">			once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="built_in">close</span>(first) &#125;)</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="comment">// all other backend types</span></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		svc := registry.Default.WatchServices()</span><br><span class="line">		man := registry.Default.WatchManual()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			<span class="keyword">select</span> &#123;</span><br><span class="line">			<span class="keyword">case</span> svccfg = &lt;-svc:</span><br><span class="line">			<span class="keyword">case</span> mancfg = &lt;-man:</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// manual config overrides service config - order matters</span></span><br><span class="line">			tableBuffer.Reset()</span><br><span class="line">			tableBuffer.WriteString(svccfg)</span><br><span class="line">			tableBuffer.WriteString(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">			tableBuffer.WriteString(mancfg)</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> nextTable = tableBuffer.String(); nextTable == lastTable &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			aliases, err := route.ParseAliases(nextTable)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Printf(<span class="string">&quot;[WARN]: %s&quot;</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line">			registry.Default.Register(aliases)</span><br><span class="line">			t, err := route.NewTable(tableBuffer)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Printf(<span class="string">&quot;[WARN] %s&quot;</span>, err)</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			route.SetTable(t)</span><br><span class="line">			logRoutes(t, lastTable, nextTable, cfg.Log.RoutesFormat)</span><br><span class="line">			lastTable = nextTable</span><br><span class="line">			once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="built_in">close</span>(first) &#125;)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Firstly in line 24, we need to understand <code>registry.Default.WatchServices()</code>. Since <code>initBackend</code> function already decided we’re using Consul mode, so we need to check the <code>WatchServices()</code> function inside the <code>Consul</code> package as following:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> consul</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *be)</span></span> WatchServices() <span class="keyword">chan</span> <span class="type">string</span> &#123;</span><br><span class="line">	log.Printf(<span class="string">&quot;[INFO] consul: Using dynamic routes&quot;</span>)</span><br><span class="line">	log.Printf(<span class="string">&quot;[INFO] consul: Using tag prefix %q&quot;</span>, b.cfg.TagPrefix)</span><br><span class="line"></span><br><span class="line">	m := NewServiceMonitor(b.c, b.cfg, b.dc)</span><br><span class="line">	svc := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>)</span><br><span class="line">	<span class="keyword">go</span> m.Watch(svc)</span><br><span class="line">	<span class="keyword">return</span> svc</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The return value is <code>svc</code> which is just a string typed <code>channel</code>. And <code>svc</code> channel is passed into goroutine <code>go m.watch()</code> as an argument. This is a very typical usage in Golang programming where two goroutines need to communicate with each other via the channel. Let’s go on and check the <code>Watch</code> function:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *ServiceMonitor)</span></span> Watch(updates <span class="keyword">chan</span> <span class="type">string</span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> lastIndex <span class="type">uint64</span></span><br><span class="line">	<span class="keyword">var</span> q *api.QueryOptions</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> w.config.PollInterval != <span class="number">0</span> &#123;</span><br><span class="line">			q = &amp;api.QueryOptions&#123;RequireConsistent: <span class="literal">true</span>&#125;</span><br><span class="line">			time.Sleep(w.config.PollInterval)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			q = &amp;api.QueryOptions&#123;RequireConsistent: <span class="literal">true</span>, WaitIndex: lastIndex&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		checks, meta, err := w.client.Health().State(<span class="string">&quot;any&quot;</span>, q)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Printf(<span class="string">&quot;[WARN] consul: Error fetching health state. %v&quot;</span>, err)</span><br><span class="line">			time.Sleep(time.Second)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		log.Printf(<span class="string">&quot;[DEBUG] consul: Health changed to #%d&quot;</span>, meta.LastIndex)</span><br><span class="line">		<span class="comment">// determine which services have passing health checks</span></span><br><span class="line">		passing := passingServices(checks, w.config.ServiceStatus, w.strict)</span><br><span class="line">		<span class="comment">// build the config for the passing services</span></span><br><span class="line">		updates &lt;- w.makeConfig(passing)</span><br><span class="line">		<span class="comment">// remember the last state and wait for the next change</span></span><br><span class="line">		lastIndex = meta.LastIndex</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You can see <code>updates &lt;- w.makeConfig(passing)</code> in Line 21, it just sends a message into the channel.  </p>
<p>Another interestring point is <code>w.client.Health().State(&quot;any&quot;, q)</code> in line 11. This is one API provided in the <code>consul/api</code> package. If you check the implementation of it, you’ll find out in fact it just sends a HTTP get request to this endpoint <code>/v1/health/state/</code> of Consul service which will return all the health check status for the services registered in Consul. </p>
<p>And the above logic runs inside a <code>for</code> loop, in this way Fabio keeps sending request to query the latest status from Consul. If new services are discovered, then the status will be updated dynamically as well, no need to restart Fabio. </p>
<p>So far you should understand how Fabio can work as a load balancer with any hardcoded routing config.  </p>
<p>Let’s go back to the <code>watchBackend</code> function to continue the analysis. </p>
<p>After debugging, I find the message passed via the <code>svc</code> channel follows the following format:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[route add demo-service /helloworld http://127.0.0.1:5000/ route add demo-service /foo http://127.0.0.1:5000/]</span><br></pre></td></tr></table></figure>

<p>Next step is converting this string message into the route table. </p>
<p>In line 46 and 51 of <code>watchBackend</code> function, you can find these two lines of code:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">t, err := route.NewTable(tableBuffer) <span class="comment">// line 46</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">route.SetTable(t) <span class="comment">// line 51</span></span><br></pre></td></tr></table></figure>

<p>Everything will be clear after you check the implementation of the <code>route</code> package. </p>
<p><code>route.NewTable()</code> function returns a <code>Table</code> type value which is map in fact. And the <code>Table</code> type declaration goes as following: </p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Table contains a set of routes grouped by host.</span></span><br><span class="line"><span class="comment">// The host routes are sorted from most to least specific</span></span><br><span class="line"><span class="comment">// by sorting the routes in reverse order by path.</span></span><br><span class="line"><span class="keyword">type</span> Table <span class="keyword">map</span>[<span class="type">string</span>]Routes</span><br><span class="line"></span><br><span class="line"><span class="comment">// Routes stores a list of routes usually for a single host.</span></span><br><span class="line"><span class="keyword">type</span> Routes []*Route</span><br><span class="line"></span><br><span class="line"><span class="comment">// Route maps a path prefix to one or more target URLs.</span></span><br><span class="line"><span class="comment">// routes can have a weight value which describes the</span></span><br><span class="line"><span class="comment">// amount of traffic this route should get. You can specify</span></span><br><span class="line"><span class="comment">// that a route should get a fixed percentage of the traffic</span></span><br><span class="line"><span class="comment">// independent of how many instances are running.</span></span><br><span class="line"><span class="keyword">type</span> Route <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// Host contains the host of the route.</span></span><br><span class="line">	<span class="comment">// not used for routing but for config generation</span></span><br><span class="line">	<span class="comment">// Table has a map with the host as key</span></span><br><span class="line">	<span class="comment">// for faster lookup and smaller search space.</span></span><br><span class="line">	Host <span class="type">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Path is the path prefix from a request uri</span></span><br><span class="line">	Path <span class="type">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Targets contains the list of URLs</span></span><br><span class="line">	Targets []*Target</span><br><span class="line"></span><br><span class="line">	<span class="comment">// wTargets contains targets distributed according to their weight</span></span><br><span class="line">	wTargets []*Target</span><br><span class="line"></span><br><span class="line">	<span class="comment">// total contains the total number of requests for this route.</span></span><br><span class="line">	<span class="comment">// Used by the RRPicker</span></span><br><span class="line">	total <span class="type">uint64</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Glob represents compiled pattern.</span></span><br><span class="line">	Glob glob.Glob</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>That’s all for the consul monitor part. Simply speaking, Fabio keeps looping the latest service status from Consul and process the status information into a routing table. </p>
<h4 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h4><p>The second part is about network proxy, which is easier to understand than the first part. </p>
<p>Fabio supports various network protocols, but in this post let’s focus on <code>HTTP/HTTPS</code> case. In side the <code>main.go</code> file, you can find the following function:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newHTTPProxy</span><span class="params">(cfg *config.Config)</span></span> http.Handler &#123;</span><br><span class="line">	<span class="keyword">var</span> w io.Writer</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Init Glob Cache</span></span><br><span class="line">	globCache := route.NewGlobCache(cfg.GlobCacheSize)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> cfg.Log.AccessTarget &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;&quot;</span>:</span><br><span class="line">		log.Printf(<span class="string">&quot;[INFO] Access logging disabled&quot;</span>)</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;stdout&quot;</span>:</span><br><span class="line">		log.Printf(<span class="string">&quot;[INFO] Writing access log to stdout&quot;</span>)</span><br><span class="line">		w = os.Stdout</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		exit.Fatal(<span class="string">&quot;[FATAL] Invalid access log target &quot;</span>, cfg.Log.AccessTarget)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	format := cfg.Log.AccessFormat</span><br><span class="line">	<span class="keyword">switch</span> format &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;common&quot;</span>:</span><br><span class="line">		format = logger.CommonFormat</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;combined&quot;</span>:</span><br><span class="line">		format = logger.CombinedFormat</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	l, err := logger.New(w, format)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		exit.Fatal(<span class="string">&quot;[FATAL] Invalid log format: &quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pick := route.Picker[cfg.Proxy.Strategy]</span><br><span class="line">	match := route.Matcher[cfg.Proxy.Matcher]</span><br><span class="line">	notFound := metrics.DefaultRegistry.GetCounter(<span class="string">&quot;notfound&quot;</span>)</span><br><span class="line">	log.Printf(<span class="string">&quot;[INFO] Using routing strategy %q&quot;</span>, cfg.Proxy.Strategy)</span><br><span class="line">	log.Printf(<span class="string">&quot;[INFO] Using route matching %q&quot;</span>, cfg.Proxy.Matcher)</span><br><span class="line"></span><br><span class="line">	newTransport := <span class="function"><span class="keyword">func</span><span class="params">(tlscfg *tls.Config)</span></span> *http.Transport &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;http.Transport&#123;</span><br><span class="line">			ResponseHeaderTimeout: cfg.Proxy.ResponseHeaderTimeout,</span><br><span class="line">			MaxIdleConnsPerHost:   cfg.Proxy.MaxConn,</span><br><span class="line">			Dial: (&amp;net.Dialer&#123;</span><br><span class="line">				Timeout:   cfg.Proxy.DialTimeout,</span><br><span class="line">				KeepAlive: cfg.Proxy.KeepAliveTimeout,</span><br><span class="line">			&#125;).Dial,</span><br><span class="line">			TLSClientConfig: tlscfg,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	authSchemes, err := auth.LoadAuthSchemes(cfg.Proxy.AuthSchemes)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		exit.Fatal(<span class="string">&quot;[FATAL] &quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;proxy.HTTPProxy&#123;</span><br><span class="line">		Config:            cfg.Proxy,</span><br><span class="line">		Transport:         newTransport(<span class="literal">nil</span>),</span><br><span class="line">		InsecureTransport: newTransport(&amp;tls.Config&#123;InsecureSkipVerify: <span class="literal">true</span>&#125;),</span><br><span class="line">		Lookup: <span class="function"><span class="keyword">func</span><span class="params">(r *http.Request)</span></span> *route.Target &#123;</span><br><span class="line">			t := route.GetTable().Lookup(r, r.Header.Get(<span class="string">&quot;trace&quot;</span>), pick, match, globCache, cfg.GlobMatchingDisabled)</span><br><span class="line">			<span class="keyword">if</span> t == <span class="literal">nil</span> &#123;</span><br><span class="line">				notFound.Inc(<span class="number">1</span>)</span><br><span class="line">				log.Print(<span class="string">&quot;[WARN] No route for &quot;</span>, r.Host, r.URL)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> t</span><br><span class="line">		&#125;,</span><br><span class="line">		Requests:    metrics.DefaultRegistry.GetTimer(<span class="string">&quot;requests&quot;</span>),</span><br><span class="line">		Noroute:     metrics.DefaultRegistry.GetCounter(<span class="string">&quot;notfound&quot;</span>),</span><br><span class="line">		Logger:      l,</span><br><span class="line">		TracerCfg:   cfg.Tracing,</span><br><span class="line">		AuthSchemes: authSchemes,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The return value’s type is <code>http.Handler</code>, which is an <strong>interface</strong> defined inside Go standard library as following:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Handler <span class="keyword">interface</span> &#123;</span><br><span class="line">	ServeHTTP(ResponseWriter, *Request)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And the actual return value’s type is <code>proxy.HTTPProxy</code> which is a <code>struct</code> implementing the <code>ServeHTTP</code> method. You can find the code inside the <code>proxy</code> package in Fabio repo. </p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> HTTPProxy <span class="keyword">struct</span> &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *HTTPProxy)</span></span> ServeHTTP(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Another point needs to be mentioned is <code>Lookup</code> field of <code>HTTPProxy</code> struct:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Lookup: <span class="function"><span class="keyword">func</span><span class="params">(r *http.Request)</span></span> *route.Target &#123;</span><br><span class="line">	t := route.GetTable().Lookup(r, r.Header.Get(<span class="string">&quot;trace&quot;</span>), pick, match, globCache, cfg.GlobMatchingDisabled)</span><br><span class="line">	<span class="keyword">if</span> t == <span class="literal">nil</span> &#123;</span><br><span class="line">		notFound.Inc(<span class="number">1</span>)</span><br><span class="line">		log.Print(<span class="string">&quot;[WARN] No route for &quot;</span>, r.Host, r.URL)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> t</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You don’t need to understand the details, just pay attention to <code>route.GetTable()</code> which is the routing table mentioned above. Consul monitor maintains the table and proxy consumes the table. That’s it.</p>
<p>In this article which is part one of this blog series , you learned how Fabio can serve as a load balancer without any config files by reviewing the design and reading the source code. </p>
<p>In part two, let’s review how Golang was used and try to summarize the best practise of wrting Golang programs.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://baoqger.github.io/2021/01/29/fabio-source-code-study/" data-id="cl8cqvbn3000emcmmgi48ebc4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Fabio-Golang-Source-code/" rel="tag">Fabio, Golang, Source code</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/02/06/golang-package-module/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Golang package
        
      </div>
    </a>
  
  
    <a href="/2020/12/30/golang-load-balancing-fabio/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Load balancing in Golang Cloud-Native microservice with Consul and Fabio</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/BPF-JIT-virtual-machine/" rel="tag">BPF, JIT, virtual machine</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Best-practice/" rel="tag">Best practice,</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fabio-Golang-Source-code/" rel="tag">Fabio, Golang, Source code</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Golang-bufio-bytes-buffer/" rel="tag">Golang, bufio, bytes, buffer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Golang-package-workspace-vendor/" rel="tag">Golang, package, workspace, vendor</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP-protocol-Golang-TCP-socket/" rel="tag">HTTP protocol, Golang, TCP, socket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP-system-call-Linux-Golang/" rel="tag">HTTP, system call, Linux, Golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP-1-1-concurrent/" rel="tag">HTTP/1.1, concurrent</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP-1-1-persistent-connection-keep-alive-TCP-netstat-tcpdump-Golang-connection-pool/" rel="tag">HTTP/1.1, persistent connection, keep-alive, TCP, netstat, tcpdump, Golang, connection pool</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTPS-TLS-handshake-SSL-TLS/" rel="tag">HTTPS, TLS handshake, SSL/TLS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-module-Netfilter-firewall/" rel="tag">Linux module, Netfilter, firewall</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-system-programming-Windows-Subsystem-for-Linux/" rel="tag">Linux, system programming, Windows Subsystem for Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TCP-IP/" rel="tag">TCP, IP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/apt-Ubuntu-Linux-package-management/" rel="tag">apt, Ubuntu, Linux, package management</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/certificate-digital-signature-hashing/" rel="tag">certificate, digital signature, hashing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/digital-signature-hash-function/" rel="tag">digital signature, hash function</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker-c-linux/" rel="tag">docker, c++, linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang-concurrent-shared-memory-message-pass/" rel="tag">golang, concurrent, shared memory, message pass</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/memory-management-stack/" rel="tag">memory management, stack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/microservice-Load-balancing-Consul-Fabio-Golang-Cloud-Native-Docker/" rel="tag">microservice, Load balancing, Consul, Fabio Golang, Cloud-Native, Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/microservice-service-registration-service-discovery-Consul-Golang-Cloud-Native-Docker/" rel="tag">microservice, service registration, service discovery, Consul, Golang, Cloud-Native, Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network-packet-capture-libpcap-analyze-and-track-network-traffics-detect-network-security-attacks-Linux-system-programming/" rel="tag">network packet capture, libpcap, analyze and track network traffics, detect network security attacks, Linux system programming</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/operating-system-xv6-Unix/" rel="tag">operating system, xv6, Unix</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/packet-sniffer-socket-PF-PACKET/" rel="tag">packet sniffer, socket, PF_PACKET</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/priority-queue-data-structure-algorithm-time-complexity-Big-O-notation/" rel="tag">priority queue, data structure, algorithm, time complexity, Big O notation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/programming-c-array-pointer/" rel="tag">programming c, array, pointer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/public-key-man-in-the-middle-certificate/" rel="tag">public key, man-in-the-middle, certificate</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/BPF-JIT-virtual-machine/" style="font-size: 10px;">BPF, JIT, virtual machine</a> <a href="/tags/Best-practice/" style="font-size: 10px;">Best practice,</a> <a href="/tags/Fabio-Golang-Source-code/" style="font-size: 10px;">Fabio, Golang, Source code</a> <a href="/tags/Golang-bufio-bytes-buffer/" style="font-size: 10px;">Golang, bufio, bytes, buffer</a> <a href="/tags/Golang-package-workspace-vendor/" style="font-size: 10px;">Golang, package, workspace, vendor</a> <a href="/tags/HTTP-protocol-Golang-TCP-socket/" style="font-size: 10px;">HTTP protocol, Golang, TCP, socket</a> <a href="/tags/HTTP-system-call-Linux-Golang/" style="font-size: 10px;">HTTP, system call, Linux, Golang</a> <a href="/tags/HTTP-1-1-concurrent/" style="font-size: 10px;">HTTP/1.1, concurrent</a> <a href="/tags/HTTP-1-1-persistent-connection-keep-alive-TCP-netstat-tcpdump-Golang-connection-pool/" style="font-size: 10px;">HTTP/1.1, persistent connection, keep-alive, TCP, netstat, tcpdump, Golang, connection pool</a> <a href="/tags/HTTPS-TLS-handshake-SSL-TLS/" style="font-size: 10px;">HTTPS, TLS handshake, SSL/TLS</a> <a href="/tags/Linux-module-Netfilter-firewall/" style="font-size: 20px;">Linux module, Netfilter, firewall</a> <a href="/tags/Linux-system-programming-Windows-Subsystem-for-Linux/" style="font-size: 10px;">Linux, system programming, Windows Subsystem for Linux</a> <a href="/tags/TCP-IP/" style="font-size: 10px;">TCP, IP</a> <a href="/tags/apt-Ubuntu-Linux-package-management/" style="font-size: 10px;">apt, Ubuntu, Linux, package management</a> <a href="/tags/certificate-digital-signature-hashing/" style="font-size: 10px;">certificate, digital signature, hashing</a> <a href="/tags/digital-signature-hash-function/" style="font-size: 15px;">digital signature, hash function</a> <a href="/tags/docker-c-linux/" style="font-size: 10px;">docker, c++, linux</a> <a href="/tags/golang-concurrent-shared-memory-message-pass/" style="font-size: 10px;">golang, concurrent, shared memory, message pass</a> <a href="/tags/memory-management-stack/" style="font-size: 10px;">memory management, stack</a> <a href="/tags/microservice-Load-balancing-Consul-Fabio-Golang-Cloud-Native-Docker/" style="font-size: 10px;">microservice, Load balancing, Consul, Fabio Golang, Cloud-Native, Docker</a> <a href="/tags/microservice-service-registration-service-discovery-Consul-Golang-Cloud-Native-Docker/" style="font-size: 10px;">microservice, service registration, service discovery, Consul, Golang, Cloud-Native, Docker</a> <a href="/tags/network-packet-capture-libpcap-analyze-and-track-network-traffics-detect-network-security-attacks-Linux-system-programming/" style="font-size: 10px;">network packet capture, libpcap, analyze and track network traffics, detect network security attacks, Linux system programming</a> <a href="/tags/operating-system-xv6-Unix/" style="font-size: 10px;">operating system, xv6, Unix</a> <a href="/tags/packet-sniffer-socket-PF-PACKET/" style="font-size: 10px;">packet sniffer, socket, PF_PACKET</a> <a href="/tags/priority-queue-data-structure-algorithm-time-complexity-Big-O-notation/" style="font-size: 10px;">priority queue, data structure, algorithm, time complexity, Big O notation</a> <a href="/tags/programming-c-array-pointer/" style="font-size: 10px;">programming c, array, pointer</a> <a href="/tags/public-key-man-in-the-middle-certificate/" style="font-size: 10px;">public key, man-in-the-middle, certificate</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/07/22/CPacketSniffer/">cPacketSniffer</a>
          </li>
        
          <li>
            <a href="/2022/06/08/how-to-write-a-netfilter-firewall-part3/">Write a Linux firewall from scratch based on Netfilter: part three - Netfilter module</a>
          </li>
        
          <li>
            <a href="/2022/05/05/how-to-write-a-netfilter-firewall-part2/">Write a Linux firewall from scratch based on Netfilter: part two - hello world module</a>
          </li>
        
          <li>
            <a href="/2022/05/04/how-to-write-a-netfilter-firewall-part1/">Write a Linux firewall from scratch based on Netfilter: part one- Netfilter and Kernel Modules</a>
          </li>
        
          <li>
            <a href="/2022/03/28/how-to-implement-libpcap-on-linux-with-raw-socket-part2/">Write a Linux packet sniffer from scratch: part two- BPF</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Chris Bao<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
    <a href="/project" class="mobile-nav-link">Project</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>