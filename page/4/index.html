<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Chris Bao&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Chris Bao&#39;s Blog">
<meta property="og:url" content="https://baoqger.github.io/page/4/index.html">
<meta property="og:site_name" content="Chris Bao&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Chris Bao">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Chris Bao&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Chris Bao&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://baoqger.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-fabio-source-code-study" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/01/29/fabio-source-code-study/" class="article-date">
  <time datetime="2021-01-29T14:09:56.000Z" itemprop="datePublished">2021-01-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/01/29/fabio-source-code-study/">Fabio source code study part 1</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h3><p>In this two-part blog series, I want to share the lessons learned from reading the soruce code of the project <code>Fabio</code>. In my previous blog, I shared with you how to use Fabio as a load balancing in the micro services applicatoins, in detail you can refer to this <a href="https://baoqger.github.io/2020/12/30/golang-load-balancing-fabio/">article</a>.  </p>
<p>Since <code>Fabio</code> is not a tiny project, it’s hard to cover everything inside this project. I will mainly focus on two aspects: firstly in the <strong>architecture design  level</strong>, I will study how it can work as a load balancer without any configuration file (Part one), and secondly in the <strong>language level</strong>, I want to summarize the best practice of writing Golang programs by investigating which features of Golang it uses and how it uses (Part two). </p>
<h3 id="Fabio-architecture-design"><a href="#Fabio-architecture-design" class="headerlink" title="Fabio architecture design"></a>Fabio architecture design</h3><p>Let’s start by introducing some background about Fabio. Following paragraph is from its official document: </p>
<blockquote>
<p>Fabio is an HTTP and TCP reverse proxy that configures itself with data from Consul. Traditional load balancers and reverse proxies need to be configured with a config file. </p>
</blockquote>
<p>If you’re familiar with other load balancer service such as <code>Nginx</code>, it will be easy for you to understand how Fabio is different and why it seems interestring. </p>
<p>For example, if you’re using <code>Nginx</code> as your load balancer, you need to maintain a config file where the routing rules need to be defined as below </p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span> /data/www;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> /images/ &#123;</span><br><span class="line">        <span class="attribute">root</span> /data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>But Fabio is a zero-conf load balancer. Cool, right? Let’s review the design and code to uncover the secrets under the hood. </p>
<p><img src="/images/fabio.png" alt="load-balancing"></p>
<p>Simply speaking, Fabio’s design can be divided into two parts: <strong>Consul monitor</strong> and <strong>proxy</strong>. Consul monitor forms and updates a <code>route table</code> by watching the data stored in Consul, and proxy distributes the request to target service instance based on the <code>route table</code>.</p>
<h4 id="main-function"><a href="#main-function" class="headerlink" title="main function"></a>main function</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	logOutput := logger.NewLevelWriter(os.Stderr, <span class="string">"INFO"</span>, <span class="string">"2017/01/01 00:00:00 "</span>)</span><br><span class="line">	log.SetOutput(logOutput)</span><br><span class="line"></span><br><span class="line">	cfg, err := config.Load(os.Args, os.Environ())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		exit.Fatalf(<span class="string">"[FATAL] %s. %s"</span>, version, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> cfg == <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(version)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	log.Printf(<span class="string">"[INFO] Setting log level to %s"</span>, logOutput.Level())</span><br><span class="line">	<span class="keyword">if</span> !logOutput.SetLevel(cfg.Log.Level) &#123;</span><br><span class="line">		log.Printf(<span class="string">"[INFO] Cannot set log level to %s"</span>, cfg.Log.Level)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	log.Printf(<span class="string">"[INFO] Runtime config\n"</span> + toJSON(cfg))</span><br><span class="line">	log.Printf(<span class="string">"[INFO] Version %s starting"</span>, version)</span><br><span class="line">	log.Printf(<span class="string">"[INFO] Go runtime is %s"</span>, runtime.Version())</span><br><span class="line"></span><br><span class="line">	WarnIfRunAsRoot(cfg.Insecure)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> prof <span class="keyword">interface</span> &#123;</span><br><span class="line">		Stop()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> cfg.ProfileMode != <span class="string">""</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> mode <span class="function"><span class="keyword">func</span><span class="params">(*profile.Profile)</span></span></span><br><span class="line">		<span class="keyword">switch</span> cfg.ProfileMode &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">""</span>:</span><br><span class="line">			<span class="comment">// do nothing</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">"cpu"</span>:</span><br><span class="line">			mode = profile.CPUProfile</span><br><span class="line">		<span class="keyword">case</span> <span class="string">"mem"</span>:</span><br><span class="line">			mode = profile.MemProfile</span><br><span class="line">		<span class="keyword">case</span> <span class="string">"mutex"</span>:</span><br><span class="line">			mode = profile.MutexProfile</span><br><span class="line">		<span class="keyword">case</span> <span class="string">"block"</span>:</span><br><span class="line">			mode = profile.BlockProfile</span><br><span class="line">		<span class="keyword">case</span> <span class="string">"trace"</span>:</span><br><span class="line">			mode = profile.TraceProfile</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			log.Fatalf(<span class="string">"[FATAL] Invalid profile mode %q"</span>, cfg.ProfileMode)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		prof = profile.Start(mode, profile.ProfilePath(cfg.ProfilePath), profile.NoShutdownHook)</span><br><span class="line">		log.Printf(<span class="string">"[INFO] Profile mode %q"</span>, cfg.ProfileMode)</span><br><span class="line">		log.Printf(<span class="string">"[INFO] Profile path %q"</span>, cfg.ProfilePath)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	exit.Listen(<span class="function"><span class="keyword">func</span><span class="params">(s os.Signal)</span></span> &#123;</span><br><span class="line">		atomic.StoreInt32(&amp;shuttingDown, <span class="number">1</span>)</span><br><span class="line">		proxy.Shutdown(cfg.Proxy.ShutdownWait)</span><br><span class="line">		<span class="keyword">if</span> prof != <span class="literal">nil</span> &#123;</span><br><span class="line">			prof.Stop()</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> registry.Default == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		registry.Default.DeregisterAll()</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	initMetrics(cfg)</span><br><span class="line">	initRuntime(cfg)</span><br><span class="line">	initBackend(cfg)</span><br><span class="line"></span><br><span class="line">	trace.InitializeTracer(&amp;cfg.Tracing)</span><br><span class="line"></span><br><span class="line">	startAdmin(cfg)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> watchNoRouteHTML(cfg)</span><br><span class="line"></span><br><span class="line">	first := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line">	<span class="keyword">go</span> watchBackend(cfg, first)</span><br><span class="line">	log.Print(<span class="string">"[INFO] Waiting for first routing table"</span>)</span><br><span class="line">	&lt;-first</span><br><span class="line"></span><br><span class="line">	startServers(cfg)</span><br><span class="line"></span><br><span class="line">	WarnIfRunAsRoot(cfg.Insecure)</span><br><span class="line"></span><br><span class="line">	exit.Wait()</span><br><span class="line">	log.Print(<span class="string">"[INFO] Down"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The <code>main</code> function defines Fabio’s workflow. To understand how Fabio works, we only need to focus on three points: </p>
<ul>
<li><strong>initBackend()</strong> and <strong>watchBackend()</strong>: these two functions contain Consul monitoring logic. </li>
<li><strong>startServers()</strong>: this function is responsible to create the network proxy.</li>
</ul>
<h4 id="Consul-monitoring"><a href="#Consul-monitoring" class="headerlink" title="Consul monitoring"></a>Consul monitoring</h4><p>First, let’s review the <code>initBackend</code> function: </p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">initBackend</span><span class="params">(cfg *config.Config)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> deadline = time.Now().Add(cfg.Registry.Timeout)</span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">switch</span> cfg.Registry.Backend &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">"file"</span>:</span><br><span class="line">			registry.Default, err = file.NewBackend(&amp;cfg.Registry.File)</span><br><span class="line">		<span class="keyword">case</span> <span class="string">"static"</span>:</span><br><span class="line">			registry.Default, err = static.NewBackend(&amp;cfg.Registry.Static)</span><br><span class="line">		<span class="keyword">case</span> <span class="string">"consul"</span>:</span><br><span class="line">			registry.Default, err = consul.NewBackend(&amp;cfg.Registry.Consul)</span><br><span class="line">		<span class="keyword">case</span> <span class="string">"custom"</span>:</span><br><span class="line">			registry.Default, err = custom.NewBackend(&amp;cfg.Registry.Custom)</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			exit.Fatal(<span class="string">"[FATAL] Unknown registry backend "</span>, cfg.Registry.Backend)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> err = registry.Default.Register(<span class="literal">nil</span>); err == <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		log.Print(<span class="string">"[WARN] Error initializing backend. "</span>, err)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> time.Now().After(deadline) &#123;</span><br><span class="line">			exit.Fatal(<span class="string">"[FATAL] Timeout registering backend."</span>)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		time.Sleep(cfg.Registry.Retry)</span><br><span class="line">		<span class="keyword">if</span> atomic.LoadInt32(&amp;shuttingDown) &gt; <span class="number">0</span> &#123;</span><br><span class="line">			exit.Exit(<span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This function is not hard to understand. Fabio supports various modes: <code>file</code>, <code>static</code>, <code>consul</code> and <code>custom</code>, and will select one mode to use based on the detailed condition inside the <code>cfg</code> parameter. In our case, we only need to focus on the <code>consul</code> mode. </p>
<p>Next let’s review <code>watchBackend()</code> function to check how it keeps watching consul’s data.</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">watchBackend</span><span class="params">(cfg *config.Config, first <span class="keyword">chan</span> <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		nextTable   <span class="keyword">string</span></span><br><span class="line">		lastTable   <span class="keyword">string</span></span><br><span class="line">		svccfg      <span class="keyword">string</span></span><br><span class="line">		mancfg      <span class="keyword">string</span></span><br><span class="line">		customBE    <span class="keyword">string</span></span><br><span class="line">		once        sync.Once</span><br><span class="line">		tableBuffer = <span class="built_in">new</span>(bytes.Buffer) <span class="comment">// fix crash on reset before used (#650)</span></span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> cfg.Registry.Backend &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">"custom"</span>:</span><br><span class="line">		svc := registry.Default.WatchServices()</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			customBE = &lt;-svc</span><br><span class="line">			<span class="keyword">if</span> customBE != <span class="string">"OK"</span> &#123;</span><br><span class="line">				log.Printf(<span class="string">"[ERROR] error during update from custom back end - %s"</span>, customBE)</span><br><span class="line">			&#125;</span><br><span class="line">			once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="built_in">close</span>(first) &#125;)</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="comment">// all other backend types</span></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		svc := registry.Default.WatchServices()</span><br><span class="line">		man := registry.Default.WatchManual()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			<span class="keyword">select</span> &#123;</span><br><span class="line">			<span class="keyword">case</span> svccfg = &lt;-svc:</span><br><span class="line">			<span class="keyword">case</span> mancfg = &lt;-man:</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// manual config overrides service config - order matters</span></span><br><span class="line">			tableBuffer.Reset()</span><br><span class="line">			tableBuffer.WriteString(svccfg)</span><br><span class="line">			tableBuffer.WriteString(<span class="string">"\n"</span>)</span><br><span class="line">			tableBuffer.WriteString(mancfg)</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> nextTable = tableBuffer.String(); nextTable == lastTable &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			aliases, err := route.ParseAliases(nextTable)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Printf(<span class="string">"[WARN]: %s"</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line">			registry.Default.Register(aliases)</span><br><span class="line">			t, err := route.NewTable(tableBuffer)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Printf(<span class="string">"[WARN] %s"</span>, err)</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			route.SetTable(t)</span><br><span class="line">			logRoutes(t, lastTable, nextTable, cfg.Log.RoutesFormat)</span><br><span class="line">			lastTable = nextTable</span><br><span class="line">			once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="built_in">close</span>(first) &#125;)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Firstly in line 24, we need to understand <code>registry.Default.WatchServices()</code>. Since <code>initBackend</code> function already decided we’re using Consul mode, so we need to check the <code>WatchServices()</code> function inside the <code>Consul</code> package as following:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> consul</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *be)</span> <span class="title">WatchServices</span><span class="params">()</span> <span class="title">chan</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	log.Printf(<span class="string">"[INFO] consul: Using dynamic routes"</span>)</span><br><span class="line">	log.Printf(<span class="string">"[INFO] consul: Using tag prefix %q"</span>, b.cfg.TagPrefix)</span><br><span class="line"></span><br><span class="line">	m := NewServiceMonitor(b.c, b.cfg, b.dc)</span><br><span class="line">	svc := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">	<span class="keyword">go</span> m.Watch(svc)</span><br><span class="line">	<span class="keyword">return</span> svc</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The return value is <code>svc</code> which is just a string typed <code>channel</code>. And <code>svc</code> channel is passed into goroutine <code>go m.watch()</code> as an argument. This is a very typical usage in Golang programming where two goroutines need to communicate with each other via the channel. Let’s go on and check the <code>Watch</code> function:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *ServiceMonitor)</span> <span class="title">Watch</span><span class="params">(updates <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> lastIndex <span class="keyword">uint64</span></span><br><span class="line">	<span class="keyword">var</span> q *api.QueryOptions</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> w.config.PollInterval != <span class="number">0</span> &#123;</span><br><span class="line">			q = &amp;api.QueryOptions&#123;RequireConsistent: <span class="literal">true</span>&#125;</span><br><span class="line">			time.Sleep(w.config.PollInterval)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			q = &amp;api.QueryOptions&#123;RequireConsistent: <span class="literal">true</span>, WaitIndex: lastIndex&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		checks, meta, err := w.client.Health().State(<span class="string">"any"</span>, q)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Printf(<span class="string">"[WARN] consul: Error fetching health state. %v"</span>, err)</span><br><span class="line">			time.Sleep(time.Second)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		log.Printf(<span class="string">"[DEBUG] consul: Health changed to #%d"</span>, meta.LastIndex)</span><br><span class="line">		<span class="comment">// determine which services have passing health checks</span></span><br><span class="line">		passing := passingServices(checks, w.config.ServiceStatus, w.strict)</span><br><span class="line">		<span class="comment">// build the config for the passing services</span></span><br><span class="line">		updates &lt;- w.makeConfig(passing)</span><br><span class="line">		<span class="comment">// remember the last state and wait for the next change</span></span><br><span class="line">		lastIndex = meta.LastIndex</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You can see <code>updates &lt;- w.makeConfig(passing)</code> in Line 21, it just sends a message into the channel.  </p>
<p>Another interestring point is <code>w.client.Health().State(&quot;any&quot;, q)</code> in line 11. This is one API provided in the <code>consul/api</code> package. If you check the implementation of it, you’ll find out in fact it just sends a HTTP get request to this endpoint <code>/v1/health/state/</code> of Consul service which will return all the health check status for the services registered in Consul. </p>
<p>And the above logic runs inside a <code>for</code> loop, in this way Fabio keeps sending request to query the latest status from Consul. If new services are discovered, then the status will be updated dynamically as well, no need to restart Fabio. </p>
<p>So far you should understand how Fabio can work as a load balancer with any hardcoded routing config.  </p>
<p>Let’s go back to the <code>watchBackend</code> function to continue the analysis. </p>
<p>After debugging, I find the message passed via the <code>svc</code> channel follows the following format:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[route add demo-service &#x2F;helloworld http:&#x2F;&#x2F;127.0.0.1:5000&#x2F; route add demo-service &#x2F;foo http:&#x2F;&#x2F;127.0.0.1:5000&#x2F;]</span><br></pre></td></tr></table></figure>

<p>Next step is converting this string message into the route table. </p>
<p>In line 46 and 51 of <code>watchBackend</code> function, you can find these two lines of code:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">t, err := route.NewTable(tableBuffer) <span class="comment">// line 46</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">route.SetTable(t) <span class="comment">// line 51</span></span><br></pre></td></tr></table></figure>

<p>Everything will be clear after you check the implementation of the <code>route</code> package. </p>
<p><code>route.NewTable()</code> function returns a <code>Table</code> type value which is map in fact. And the <code>Table</code> type declaration goes as following: </p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Table contains a set of routes grouped by host.</span></span><br><span class="line"><span class="comment">// The host routes are sorted from most to least specific</span></span><br><span class="line"><span class="comment">// by sorting the routes in reverse order by path.</span></span><br><span class="line"><span class="keyword">type</span> Table <span class="keyword">map</span>[<span class="keyword">string</span>]Routes</span><br><span class="line"></span><br><span class="line"><span class="comment">// Routes stores a list of routes usually for a single host.</span></span><br><span class="line"><span class="keyword">type</span> Routes []*Route</span><br><span class="line"></span><br><span class="line"><span class="comment">// Route maps a path prefix to one or more target URLs.</span></span><br><span class="line"><span class="comment">// routes can have a weight value which describes the</span></span><br><span class="line"><span class="comment">// amount of traffic this route should get. You can specify</span></span><br><span class="line"><span class="comment">// that a route should get a fixed percentage of the traffic</span></span><br><span class="line"><span class="comment">// independent of how many instances are running.</span></span><br><span class="line"><span class="keyword">type</span> Route <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// Host contains the host of the route.</span></span><br><span class="line">	<span class="comment">// not used for routing but for config generation</span></span><br><span class="line">	<span class="comment">// Table has a map with the host as key</span></span><br><span class="line">	<span class="comment">// for faster lookup and smaller search space.</span></span><br><span class="line">	Host <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Path is the path prefix from a request uri</span></span><br><span class="line">	Path <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Targets contains the list of URLs</span></span><br><span class="line">	Targets []*Target</span><br><span class="line"></span><br><span class="line">	<span class="comment">// wTargets contains targets distributed according to their weight</span></span><br><span class="line">	wTargets []*Target</span><br><span class="line"></span><br><span class="line">	<span class="comment">// total contains the total number of requests for this route.</span></span><br><span class="line">	<span class="comment">// Used by the RRPicker</span></span><br><span class="line">	total <span class="keyword">uint64</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Glob represents compiled pattern.</span></span><br><span class="line">	Glob glob.Glob</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>That’s all for the consul monitor part. Simply speaking, Fabio keeps looping the latest service status from Consul and process the status information into a routing table. </p>
<h4 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h4><p>The second part is about network proxy, which is easier to understand than the first part. </p>
<p>Fabio supports various network protocols, but in this post let’s focus on <code>HTTP/HTTPS</code> case. In side the <code>main.go</code> file, you can find the following function:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newHTTPProxy</span><span class="params">(cfg *config.Config)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> w io.Writer</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Init Glob Cache</span></span><br><span class="line">	globCache := route.NewGlobCache(cfg.GlobCacheSize)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> cfg.Log.AccessTarget &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">""</span>:</span><br><span class="line">		log.Printf(<span class="string">"[INFO] Access logging disabled"</span>)</span><br><span class="line">	<span class="keyword">case</span> <span class="string">"stdout"</span>:</span><br><span class="line">		log.Printf(<span class="string">"[INFO] Writing access log to stdout"</span>)</span><br><span class="line">		w = os.Stdout</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		exit.Fatal(<span class="string">"[FATAL] Invalid access log target "</span>, cfg.Log.AccessTarget)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	format := cfg.Log.AccessFormat</span><br><span class="line">	<span class="keyword">switch</span> format &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">"common"</span>:</span><br><span class="line">		format = logger.CommonFormat</span><br><span class="line">	<span class="keyword">case</span> <span class="string">"combined"</span>:</span><br><span class="line">		format = logger.CombinedFormat</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	l, err := logger.New(w, format)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		exit.Fatal(<span class="string">"[FATAL] Invalid log format: "</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pick := route.Picker[cfg.Proxy.Strategy]</span><br><span class="line">	match := route.Matcher[cfg.Proxy.Matcher]</span><br><span class="line">	notFound := metrics.DefaultRegistry.GetCounter(<span class="string">"notfound"</span>)</span><br><span class="line">	log.Printf(<span class="string">"[INFO] Using routing strategy %q"</span>, cfg.Proxy.Strategy)</span><br><span class="line">	log.Printf(<span class="string">"[INFO] Using route matching %q"</span>, cfg.Proxy.Matcher)</span><br><span class="line"></span><br><span class="line">	newTransport := <span class="function"><span class="keyword">func</span><span class="params">(tlscfg *tls.Config)</span> *<span class="title">http</span>.<span class="title">Transport</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> &amp;http.Transport&#123;</span><br><span class="line">			ResponseHeaderTimeout: cfg.Proxy.ResponseHeaderTimeout,</span><br><span class="line">			MaxIdleConnsPerHost:   cfg.Proxy.MaxConn,</span><br><span class="line">			Dial: (&amp;net.Dialer&#123;</span><br><span class="line">				Timeout:   cfg.Proxy.DialTimeout,</span><br><span class="line">				KeepAlive: cfg.Proxy.KeepAliveTimeout,</span><br><span class="line">			&#125;).Dial,</span><br><span class="line">			TLSClientConfig: tlscfg,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	authSchemes, err := auth.LoadAuthSchemes(cfg.Proxy.AuthSchemes)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		exit.Fatal(<span class="string">"[FATAL] "</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;proxy.HTTPProxy&#123;</span><br><span class="line">		Config:            cfg.Proxy,</span><br><span class="line">		Transport:         newTransport(<span class="literal">nil</span>),</span><br><span class="line">		InsecureTransport: newTransport(&amp;tls.Config&#123;InsecureSkipVerify: <span class="literal">true</span>&#125;),</span><br><span class="line">		Lookup: <span class="function"><span class="keyword">func</span><span class="params">(r *http.Request)</span> *<span class="title">route</span>.<span class="title">Target</span></span> &#123;</span><br><span class="line">			t := route.GetTable().Lookup(r, r.Header.Get(<span class="string">"trace"</span>), pick, match, globCache, cfg.GlobMatchingDisabled)</span><br><span class="line">			<span class="keyword">if</span> t == <span class="literal">nil</span> &#123;</span><br><span class="line">				notFound.Inc(<span class="number">1</span>)</span><br><span class="line">				log.Print(<span class="string">"[WARN] No route for "</span>, r.Host, r.URL)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> t</span><br><span class="line">		&#125;,</span><br><span class="line">		Requests:    metrics.DefaultRegistry.GetTimer(<span class="string">"requests"</span>),</span><br><span class="line">		Noroute:     metrics.DefaultRegistry.GetCounter(<span class="string">"notfound"</span>),</span><br><span class="line">		Logger:      l,</span><br><span class="line">		TracerCfg:   cfg.Tracing,</span><br><span class="line">		AuthSchemes: authSchemes,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The return value’s type is <code>http.Handler</code>, which is an <strong>interface</strong> defined inside Go standard library as following:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Handler <span class="keyword">interface</span> &#123;</span><br><span class="line">	ServeHTTP(ResponseWriter, *Request)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And the actual return value’s type is <code>proxy.HTTPProxy</code> which is a <code>struct</code> implementing the <code>ServeHTTP</code> method. You can find the code inside the <code>proxy</code> package in Fabio repo. </p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> HTTPProxy <span class="keyword">struct</span> &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *HTTPProxy)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Another point needs to be mentioned is <code>Lookup</code> field of <code>HTTPProxy</code> struct:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Lookup: <span class="function"><span class="keyword">func</span><span class="params">(r *http.Request)</span> *<span class="title">route</span>.<span class="title">Target</span></span> &#123;</span><br><span class="line">	t := route.GetTable().Lookup(r, r.Header.Get(<span class="string">"trace"</span>), pick, match, globCache, cfg.GlobMatchingDisabled)</span><br><span class="line">	<span class="keyword">if</span> t == <span class="literal">nil</span> &#123;</span><br><span class="line">		notFound.Inc(<span class="number">1</span>)</span><br><span class="line">		log.Print(<span class="string">"[WARN] No route for "</span>, r.Host, r.URL)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> t</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>You don’t need to understand the details, just pay attention to <code>route.GetTable()</code> which is the routing table mentioned above. Consul monitor maintains the table and proxy consumes the table. That’s it.</p>
<p>In this article which is part one of this blog series , you learned how Fabio can serve as a load balancer without any config files by reviewing the design and reading the source code. </p>
<p>In part two, let’s review how Golang was used and try to summarize the best practise of wrting Golang programs.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://baoqger.github.io/2021/01/29/fabio-source-code-study/" data-id="ckzkmc7jt00077kmm9dk89cdz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Fabio-Golang-Source-code/" rel="tag">Fabio, Golang, Source code</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-golang-load-balancing-fabio" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/12/30/golang-load-balancing-fabio/" class="article-date">
  <time datetime="2020-12-30T01:56:57.000Z" itemprop="datePublished">2020-12-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/12/30/golang-load-balancing-fabio/">Load balancing in Golang Cloud-Native microservice with Consul and Fabio</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h3><p>In the <a href="https://baoqger.github.io/2020/11/16/golang-service-discovery-consul/">last post</a>, I show you how to do service discovery in a Golang Cloud-Native microservice application based on Consul and Docker with a real demo. In that demo, the simple <code>helloworld-server</code> service is registered in Consul and the <code>helloworld-client</code> can discover the dynamic address of the service via Consul. But the previous demo has one limitation, as I mentioned in the last post, in the real world microservice application, each service may have multiple instances to handle the network requests. </p>
<p>In this post, I will expand the demo to show you how to do <code>load balancing</code> when multiple instances of one service are registered in Consul. </p>
<p>Continue with the last post, the new demo will keep using Cloud-Native way with <code>Docker</code> and <code>Docker-compose</code>.</p>
<h3 id="Fabio-for-load-balancing"><a href="#Fabio-for-load-balancing" class="headerlink" title="Fabio for load balancing"></a>Fabio for load balancing</h3><p>To do load balancing for Consul, there are several strategies are recommended from the Consul official document. In this post I choose to use <a href="https://github.com/fabiolb/fabio" target="_blank" rel="noopener">Fabio</a>. </p>
<blockquote>
<p>Fabio is an open source tool that provides fast, modern, zero-conf load balancing HTTP(S) and TCP router for services managed by Consul. Users register services in Consul with a health check and fabio will automatically route traffic to them. No additional configuration required.</p>
</blockquote>
<p>Fabio is an interesting project, it realizes loading balancing based on the <code>tag</code> information of service registration in Consul. </p>
<p>Users register a service with a tag beginning with <code>urlprefix-</code>, like:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">urlprefix-&#x2F;my-service</span><br></pre></td></tr></table></figure>

<p>Then when a request is made to fabio at <code>/my-service</code>, fabio will automatically route traffic to a healthy service in the cluster. I will show you how to do it in the following demo. And I will also do simple research on how Fabio realizes this load balancing strategy by reviewing the source code and share the findings in the next post. </p>
<h3 id="Fabio-load-balancing-demo"><a href="#Fabio-load-balancing-demo" class="headerlink" title="Fabio load balancing demo"></a>Fabio load balancing demo</h3><p>Firstly, all the code and config files shown in this post can be found in this <a href="https://github.com/baoqger/service-discovery-demo" target="_blank" rel="noopener">github repo</a>, please <code>git checkout</code> the <code>load-balancing</code> branch for this post’s demo. </p>
<h4 id="Server-side"><a href="#Server-side" class="headerlink" title="Server side"></a>Server side</h4><p>For the <code>helloworld-server</code>, there are two changes:</p>
<ul>
<li>First, each service instance should have an unique <code>ID</code>;</li>
<li>Second, add <code>Tags</code> for service registration and the tag should follow the rule of <code>Fabio</code>. </li>
</ul>
<p>Ok, let’s check the new version code. </p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">	<span class="string">"strconv"</span></span><br><span class="line"></span><br><span class="line">	consulapi <span class="string">"github.com/hashicorp/consul/api"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	serviceRegistryWithConsul()</span><br><span class="line">	log.Println(<span class="string">"Starting Hello World Server..."</span>)</span><br><span class="line">	http.HandleFunc(<span class="string">"/helloworld"</span>, helloworld)</span><br><span class="line">	http.HandleFunc(<span class="string">"/check"</span>, check)</span><br><span class="line">	http.ListenAndServe(getPort(), <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">serviceRegistryWithConsul</span><span class="params">()</span></span> &#123;</span><br><span class="line">	config := consulapi.DefaultConfig()</span><br><span class="line">	consul, err := consulapi.NewClient(config)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	port, _ := strconv.Atoi(getPort()[<span class="number">1</span>:<span class="built_in">len</span>(getPort())])</span><br><span class="line">	address := getHostname()</span><br><span class="line">	<span class="comment">/* Each service instance should have an unique serviceID */</span></span><br><span class="line">	serviceID := fmt.Sprintf(<span class="string">"helloworld-server-%s:%v"</span>, address, port)</span><br><span class="line">	<span class="comment">/* Tag should follow the rule of Fabio: urlprefix- */</span></span><br><span class="line">	tags := []<span class="keyword">string</span>&#123;<span class="string">"urlprefix-/helloworld"</span>&#125;</span><br><span class="line"></span><br><span class="line">	registration := &amp;consulapi.AgentServiceRegistration&#123;</span><br><span class="line">		ID:      serviceID,</span><br><span class="line">		Name:    <span class="string">"helloworld-server"</span>,</span><br><span class="line">		Port:    port,</span><br><span class="line">		Address: address,</span><br><span class="line">		Tags:    tags, <span class="comment">/* Add Tags for registration */</span></span><br><span class="line">		Check: &amp;consulapi.AgentServiceCheck&#123;</span><br><span class="line">			HTTP:     fmt.Sprintf(<span class="string">"http://%s:%v/check"</span>, address, port),</span><br><span class="line">			Interval: <span class="string">"10s"</span>,</span><br><span class="line">			Timeout:  <span class="string">"30s"</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	regiErr := consul.Agent().ServiceRegister(registration)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> regiErr != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Printf(<span class="string">"Failed to register service: %s:%v "</span>, address, port)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		log.Printf(<span class="string">"successfully register service: %s:%v"</span>, address, port)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">helloworld</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	log.Println(<span class="string">"helloworld service is called."</span>)</span><br><span class="line">	w.WriteHeader(http.StatusOK)</span><br><span class="line">	fmt.Fprintf(w, <span class="string">"Hello world."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">check</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	w.WriteHeader(http.StatusOK)</span><br><span class="line">	fmt.Fprintf(w, <span class="string">"Consul check"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getPort</span><span class="params">()</span> <span class="params">(port <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	port = os.Getenv(<span class="string">"PORT"</span>)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(port) == <span class="number">0</span> &#123;</span><br><span class="line">		port = <span class="string">"8080"</span></span><br><span class="line">	&#125;</span><br><span class="line">	port = <span class="string">":"</span> + port</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getHostname</span><span class="params">()</span> <span class="params">(hostname <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	hostname, _ = os.Hostname()</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="server-go"><a href="#server-go" class="headerlink" title="server.go"></a><strong><code>server.go</code></strong></h5><p>The changes are at Line 30, 32 and 40 and comments are added there to explain the purpose of the change. Simply speaking, now each service instance registers itself with a unique ID, which is consisted of the basic service name (helloworld-server in this case) and the dynamic address. Also, we add <code>urlprefix-/helloworld</code> <strong>Tags</strong> for each registration. <code>urlprefix-</code> is the default config of Fabio, you can set customized prefix if needed. Based on this <strong>Tags</strong>, Fabio can do automatic load balancing for the <code>/helloworld</code> endpoint. </p>
<p>That’s all for the code change for server side. Let’s review the changes for the client. </p>
<h4 id="Client-side"><a href="#Client-side" class="headerlink" title="Client side"></a>Client side</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"io/ioutil"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line"></span><br><span class="line">	consulapi <span class="string">"github.com/hashicorp/consul/api"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> url <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">For load balancing, run fabioLoadBalancing();</span></span><br><span class="line"><span class="comment">For simple service discovery, run serviceDiscoveryWithConsul();</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fabioLoadBalancing()</span><br><span class="line">	fmt.Println(<span class="string">"Starting Client."</span>)</span><br><span class="line">	<span class="keyword">var</span> client = &amp;http.Client&#123;</span><br><span class="line">		Timeout: time.Second * <span class="number">30</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	callServerEvery(<span class="number">10</span>*time.Second, client)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Load balancing with Fabio */</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fabioLoadBalancing</span><span class="params">()</span></span> &#123;</span><br><span class="line">	address := os.Getenv(<span class="string">"FABIO_HTTP_ADDR"</span>)</span><br><span class="line">	url = fmt.Sprintf(<span class="string">"http://%s/helloworld"</span>, address)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Service Discovery with Consul */</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">serviceDiscoveryWithConsul</span><span class="params">()</span></span> &#123;</span><br><span class="line">	config := consulapi.DefaultConfig()</span><br><span class="line">	consul, error := consulapi.NewClient(config)</span><br><span class="line">	<span class="keyword">if</span> error != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(error)</span><br><span class="line">	&#125;</span><br><span class="line">	services, error := consul.Agent().Services()</span><br><span class="line">	<span class="keyword">if</span> error != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(error)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	service := services[<span class="string">"helloworld-server"</span>]</span><br><span class="line">	address := service.Address</span><br><span class="line">	port := service.Port</span><br><span class="line">	url = fmt.Sprintf(<span class="string">"http://%s:%v/helloworld"</span>, address, port)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hello</span><span class="params">(t time.Time, client *http.Client)</span></span> &#123;</span><br><span class="line">	response, err := client.Get(url)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	body, _ := ioutil.ReadAll(response.Body)</span><br><span class="line">	fmt.Printf(<span class="string">"%s. Time is %v\n"</span>, body, t)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">callServerEvery</span><span class="params">(d time.Duration, client *http.Client)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> x := <span class="keyword">range</span> time.Tick(d) &#123;</span><br><span class="line">		hello(x, client)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="client-go"><a href="#client-go" class="headerlink" title="client.go"></a><strong><code>client.go</code></strong></h5><p>Previously, we need to run <code>serviceDiscoveryWithConsul</code> to discover the service address to call. Now since we have <code>Fabio</code> working as the load balancer, so we send the request to <code>Fabio</code> and our request will be distributed to the service instance by <code>Fabio</code>.</p>
<p>This part of logic is implemented inside the following method: </p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Load balancing with Fabio */</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fabioLoadBalancing</span><span class="params">()</span></span> &#123;</span><br><span class="line">	address := os.Getenv(<span class="string">"FABIO_HTTP_ADDR"</span>)</span><br><span class="line">	url = fmt.Sprintf(<span class="string">"http://%s/helloworld"</span>, address)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>To get the address of the Fabio service, we need to config it as an environment variable, which will be set in the <code>yml</code> file of Docker-compose. Let’s review the new <code>yml</code> file now. </p>
<h4 id="Docker-compose-config"><a href="#Docker-compose-config" class="headerlink" title="Docker-compose config"></a>Docker-compose config</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'2'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span> </span><br><span class="line">  <span class="attr">consul:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">consul:0.8.3</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"8500:8500"</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">my-net</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">helloworld-server:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">server/Dockerfile</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">helloworld-server:1.0.2</span> <span class="comment"># upgrade to v1.0.2</span></span><br><span class="line">    <span class="attr">environment:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">CONSUL_HTTP_ADDR=consul:8500</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">consul</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">my-net</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">helloworld-client:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">client/Dockerfile</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">helloworld-client:1.0.2</span> <span class="comment"># upgrade to v1.0.2</span></span><br><span class="line">    <span class="attr">environment:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">CONSUL_HTTP_ADDR=consul:8500</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">FABIO_HTTP_ADDR=fabio:9999</span> <span class="comment"># environment variable for fabio service address</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">consul</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">helloworld-server</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">my-net</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">fabio:</span> <span class="comment"># add a new service: Fabio as load balancer</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">fabiolb/fabio:latest</span></span><br><span class="line">    <span class="attr">environment:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">registry_consul_addr=consul:8500</span> <span class="comment"># environment variable for consul service address</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">proxy_strategy=rr</span> <span class="comment"># environment variable for load balancing strategy. rr is round-robin      </span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"9998:9998"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"9999:9999"</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">consul</span>  </span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">my-net</span> </span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">my-net:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure>
<h5 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a><strong><code>docker-compose.yml</code></strong></h5><p>There several changes in this <code>yml</code> config file:</p>
<ul>
<li>Add a new service <code>Fabio</code>. As mentioned above Fabio is a zero-conf load balancing, which can simply run as a docker container. This is so convenient and totally matches Cloud-Native style. The two environment variables: <code>registry_consul_addr</code> and <code>proxy_strategy</code>, are set to define the Consul’s address and the round-robin strategy. </li>
<li>Set the <code>FABIO_HTTP_ADDR</code> environment variable for the client. This is what we mentioned in the last section, which allows <code>client.go</code> to get Fabio service address and send requests. </li>
<li>Upgrade two docker images to <strong>v1.0.2</strong>.  </li>
</ul>
<h4 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h4><p>It’s time to run the demo! Suppose you have all the docker images build on your local machine, then run the following command: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up --scale helloworld-server&#x3D;3</span><br></pre></td></tr></table></figure>

<p>This command has an important tip about Docker-compose: how to run multiple instances of certain service. In our case, we need multiple instances of <code>helloworld-server</code> for load balancing. Docker-compose supports this functionality with <code>--scale</code> option. For the above command, 3 instances of helloworld-server will be launched.</p>
<p>You can see the demo’s result in the following image: </p>
<p><img src="/images/load-balancing.png" alt="load-balancing"></p>
<p>The client repeatedly and periodically sends the request and each request is distributed by Fabio to one of the three instances in round-robin style. Just what we expect! </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://baoqger.github.io/2020/12/30/golang-load-balancing-fabio/" data-id="ckzkmc7jy000k7kmm4f4oc4x7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/microservice-Load-balancing-Consul-Fabio-Golang-Cloud-Native-Docker/" rel="tag">microservice, Load balancing, Consul, Fabio Golang, Cloud-Native, Docker</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-svg-data-vis" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/12/01/svg-data-vis/" class="article-date">
  <time datetime="2020-12-01T00:44:04.000Z" itemprop="datePublished">2020-12-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/12/01/svg-data-vis/">svg-data-vis</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://baoqger.github.io/2020/12/01/svg-data-vis/" data-id="ckzkmc7kf00237kmmg475br5q" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-golang-service-discovery-consul" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/11/16/golang-service-discovery-consul/" class="article-date">
  <time datetime="2020-11-16T01:22:23.000Z" itemprop="datePublished">2020-11-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/11/16/golang-service-discovery-consul/">Service registry and discovery in Golang Cloud-Native microservice with Consul and Docker</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h3><p>In this post, I will give a real demo application to show how to do service registration and discovery in <code>Cloud-Native</code> microservice architecture based on <code>Consul</code> and <code>Docker</code>. And the service is developed in <code>Golang</code> language.</p>
<p>It will cover the following technical points:</p>
<ul>
<li>Integrate Consul with Golang application for service registration</li>
<li>Integrate Consul with Golang application for service discovery</li>
<li>Configure and Run the microservices with Docker(docker-compose)</li>
</ul>
<p>As you can see, this post will cover several critical concepts and interesting tools. I will do a quick and brief introduction of them. </p>
<ul>
<li><p><strong>Cloud-Native</strong>: this is another buzzword in the software industry. One of the key attributes of Cloud-Native application is <code>containerized</code>. To be considered cloud native, an application must be <code>infrastructure agnostic</code> and use containers. Containers provide applications the ability to run as a stand-alone environment able to move in and out of the cloud and have no dependencies on any certain cloud provider. </p>
</li>
<li><p><strong>Service Registration and Service Discovery</strong>: in the microservices application, each service needs to call other services. In order to make a request, your service needs to know the network address of a service instance. In a cloud-based microservices application, the network location is dynamically assigned. So your application needs a service discovery mechanism. On the other hand, the service registry acts as a database storing the available service instances.</p>
</li>
<li><p><strong>Consul</strong>: Consul is the tool we used in this demo application for service registry and discovery. Consul is a member in <code>CNCF(Cloud Native Computing Foundation)</code>. I will try to write a post to analyze its source code in the future.</p>
</li>
<li><p><strong>Docker-compose</strong>: is a tool to run multi-container applications on Docker. It allows different containers can communicate with each other. In this post, I will show you how to use it as well. </p>
</li>
</ul>
<p>All the code and config file can be found in this <a href="https://github.com/baoqger/service-discovery-demo" target="_blank" rel="noopener">github repo</a>, please checkout the <code>service-discovery</code> branch for this post’s demo. </p>
<h3 id="Service-registry-and-discovery-demo"><a href="#Service-registry-and-discovery-demo" class="headerlink" title="Service registry and discovery demo"></a>Service registry and discovery demo</h3><p>To explain service registry and discovery, I will run a simple <code>helloworld</code> server and a client which keeps sending requests to the server every 10 seconds. The demo <code>helloworld</code> server will register itself in <code>Consul</code>, and this process is just service registry. On the other side, before the client sends a request to the server, it will first send a request to <code>Consul</code> and find the address of the server. This process is just service discovery.  OK, let’s show some code. </p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">	<span class="string">"strconv"</span></span><br><span class="line"></span><br><span class="line">	consulapi <span class="string">"github.com/hashicorp/consul/api"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	serviceRegistryWithConsul()</span><br><span class="line">	log.Println(<span class="string">"Starting Hello World Server..."</span>)</span><br><span class="line">	http.HandleFunc(<span class="string">"/helloworld"</span>, helloworld)</span><br><span class="line">	http.HandleFunc(<span class="string">"/check"</span>, check)</span><br><span class="line">	http.ListenAndServe(getPort(), <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">serviceRegistryWithConsul</span><span class="params">()</span></span> &#123;</span><br><span class="line">	config := consulapi.DefaultConfig()</span><br><span class="line">	consul, err := consulapi.NewClient(config)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	serviceID := <span class="string">"helloworld-server"</span></span><br><span class="line">	port, _ := strconv.Atoi(getPort()[<span class="number">1</span>:<span class="built_in">len</span>(getPort())])</span><br><span class="line">	address := getHostname()</span><br><span class="line"></span><br><span class="line">	registration := &amp;consulapi.AgentServiceRegistration&#123;</span><br><span class="line">		ID:      serviceID,</span><br><span class="line">		Name:    <span class="string">"helloworld-server"</span>,</span><br><span class="line">		Port:    port,</span><br><span class="line">		Address: address,</span><br><span class="line">		Check: &amp;consulapi.AgentServiceCheck&#123;</span><br><span class="line">			HTTP:     fmt.Sprintf(<span class="string">"http://%s:%v/check"</span>, address, port),</span><br><span class="line">			Interval: <span class="string">"10s"</span>,</span><br><span class="line">			Timeout:  <span class="string">"30s"</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	regiErr := consul.Agent().ServiceRegister(registration)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> regiErr != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Printf(<span class="string">"Failed to register service: %s:%v "</span>, address, port)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		log.Printf(<span class="string">"successfully register service: %s:%v"</span>, address, port)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">helloworld</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	log.Println(<span class="string">"helloworld service is called."</span>)</span><br><span class="line">	w.WriteHeader(http.StatusOK)</span><br><span class="line">	fmt.Fprintf(w, <span class="string">"Hello world."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">check</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	w.WriteHeader(http.StatusOK)</span><br><span class="line">	fmt.Fprintf(w, <span class="string">"Consul check"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getPort</span><span class="params">()</span> <span class="params">(port <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	port = os.Getenv(<span class="string">"PORT"</span>)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(port) == <span class="number">0</span> &#123;</span><br><span class="line">		port = <span class="string">"8080"</span></span><br><span class="line">	&#125;</span><br><span class="line">	port = <span class="string">":"</span> + port</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getHostname</span><span class="params">()</span> <span class="params">(hostname <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	hostname, _ = os.Hostname()</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="server-go"><a href="#server-go" class="headerlink" title="server.go"></a><strong><code>server.go</code></strong></h5><p>The above <code>server.go</code> file contains many codes, but most of them are easy, and just for setting up the server and handling the request. </p>
<p>The interesting part is inside function <code>serviceRegistryWithConsul</code>. Consul provides APIs to register service by configuring the necessary information. For now, we can focus on two fields, the first one is <code>ID</code> which is unique for each service and we also use it for search the target service in the discovery process. The second one is <code>Check</code>, which means <code>health check</code>. Consul provides this helpful functionality. In the real microservices application, each service may have multiple instances to handle the increased requests when the concurrency is high, this is called <code>scalability</code>. But some instances may go down or throw exceptions, in service discovery we want to filter these instances out. Health check in Consul is just for this purpose. I will show you how to do that in the <a href="https://baoqger.github.io/2020/12/30/golang-load-balancing-fabio/">next post</a>.  </p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"io/ioutil"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line"></span><br><span class="line">	consulapi <span class="string">"github.com/hashicorp/consul/api"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> url <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	serviceDiscoveryWithConsul()</span><br><span class="line">	fmt.Println(<span class="string">"Starting Client."</span>)</span><br><span class="line">	<span class="keyword">var</span> client = &amp;http.Client&#123;</span><br><span class="line">		Timeout: time.Second * <span class="number">30</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	callServerEvery(<span class="number">10</span>*time.Second, client)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">serviceDiscoveryWithConsul</span><span class="params">()</span></span> &#123;</span><br><span class="line">	config := consulapi.DefaultConfig()</span><br><span class="line">	consul, error := consulapi.NewClient(config)</span><br><span class="line">	<span class="keyword">if</span> error != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(error)</span><br><span class="line">	&#125;</span><br><span class="line">	services, error := consul.Agent().Services()</span><br><span class="line">	<span class="keyword">if</span> error != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(error)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	service := services[<span class="string">"helloworld-server"</span>]</span><br><span class="line">	address := service.Address</span><br><span class="line">	port := service.Port</span><br><span class="line">	url = fmt.Sprintf(<span class="string">"http://%s:%v/helloworld"</span>, address, port)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hello</span><span class="params">(t time.Time, client *http.Client)</span></span> &#123;</span><br><span class="line">	response, err := client.Get(url)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	body, _ := ioutil.ReadAll(response.Body)</span><br><span class="line">	fmt.Printf(<span class="string">"%s. Time is %v\n"</span>, body, t)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">callServerEvery</span><span class="params">(d time.Duration, client *http.Client)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> x := <span class="keyword">range</span> time.Tick(d) &#123;</span><br><span class="line">		hello(x, client)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="client-go"><a href="#client-go" class="headerlink" title="client.go"></a><strong><code>client.go</code></strong></h5><p>Similarly, in the <code>client.go</code> file, the only key part is <code>serviceDiscoveryWithConsul</code> function. Based on the Consul APIs, we can find out all the services. With the target service id (in this demo is <code>helloworld-server</code>) which is set in the registration part, we can easily find out the address. </p>
<p>The above parts show how to do the service registry and discovery in a completed demo. It makes use of Consul APIs a lot, I didn’t give too many explanations on that, since you can find out more detailed information in the document. </p>
<p>In the next section, I will show you how to run this demo application in a Cloud-Native way based on Docker and Docker-compose. </p>
<h3 id="Containerization"><a href="#Containerization" class="headerlink" title="Containerization"></a>Containerization</h3><p>First let’s create Dockerfile for the server as following:</p>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.14</span>.<span class="number">1</span>-alpine</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apk update &amp;&amp; apk upgrade &amp;&amp; apk add --no-cache bash git</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> go get github.com/hashicorp/consul/api</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> SOURCES /go/src/github.com/baoqger/service-discovery-demo/</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . <span class="variable">$&#123;SOURCES&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> <span class="variable">$&#123;SOURCES&#125;</span>server/ &amp;&amp; CGO_ENABLED=0 go build</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> CONSUL_HTTP_ADDR localhost:<span class="number">8500</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> <span class="variable">$&#123;SOURCES&#125;</span>server/</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> <span class="variable">$&#123;SOURCES&#125;</span>server/server</span></span><br></pre></td></tr></table></figure>
<h5 id="Dockerfile-for-server-go"><a href="#Dockerfile-for-server-go" class="headerlink" title="Dockerfile for server.go"></a><strong><code>Dockerfile</code> for server.go</strong></h5><p>This part is straightforward, if you don’t understand some of the commands used here please check the Docker’s manual. </p>
<p>I will not show the Dockerfile for the client any more, since it’s nearly the same as the above one. But you can find it in this <a href="https://github.com/baoqger/service-discovery-demo" target="_blank" rel="noopener">github repo</a>.</p>
<p>Now we have both server and client running in containers. We need add the Consul into this application as well, and connect these 3 containers together. We do this with Docker-compose. </p>
<p>Docker-compose is driven by the <code>yml</code> file. In our case, it goes as following:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'2'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span> </span><br><span class="line">  <span class="attr">consul:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">consul:0.8.3</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"8500:8500"</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">my-net</span></span><br><span class="line">      </span><br><span class="line">  <span class="attr">helloworld-server:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">server/Dockerfile</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">helloworld-server:1.0.1</span></span><br><span class="line">    <span class="attr">environment:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">CONSUL_HTTP_ADDR=consul:8500</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">consul</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">my-net</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">helloworld-client:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">client/Dockerfile</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">helloworld-client:1.0.1</span></span><br><span class="line">    <span class="attr">environment:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">CONSUL_HTTP_ADDR=consul:8500</span> </span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">consul</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">helloworld-server</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">my-net</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">my-net:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure>

<p>There are several points need to mention about docker-compose usages:</p>
<ul>
<li><strong>networks</strong>: we define a network called <code>my-net</code>, and use it in all of the 3 services to make them can talk with each other. </li>
<li><strong>environment</strong>: we can set up the environment variable in this part. In our case, both server and client need to send requests to Consul for registry and discovery, right? You can check the server and client file, we didn’t set the Consul address explicitly. Since Consul do it in an implicit way, it will get the value from the environment variable named <code>CONSUL_HTTP_ADDR</code>. We set it up with <code>CONSUL_HTTP_ADDR=consul:8500</code>. </li>
<li><strong>docker-compose up</strong>: this is the command all you need to launch the application. Another helpful command is <code>docker-compose build</code> which is used to build the image defined in the yml file. Of course, <code>docker-compose down</code> can stop the containers when you want to leave the application. </li>
</ul>
<p>Everything is setted up, you can verify the result both in the terminal and Consul UI as following:</p>
<p><img src="/images/service-discovery.png" alt="service-discovery"></p>
<p><img src="/images/consul-ui.png" alt="consul-ui"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://baoqger.github.io/2020/11/16/golang-service-discovery-consul/" data-id="ckzkmc7k0000q7kmm60s2ev8a" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/microservice-service-registration-service-discovery-Consul-Golang-Cloud-Native-Docker/" rel="tag">microservice, service registration, service discovery, Consul, Golang, Cloud-Native, Docker</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-golang-concurrent-twoways" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/26/golang-concurrent-twoways/" class="article-date">
  <time datetime="2020-10-26T02:29:32.000Z" itemprop="datePublished">2020-10-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/26/golang-concurrent-twoways/">Golang inter Goroutine communication - shared memory or channels</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>This post will demonstrate how to do inter-thread communication in Golang concurrent programming. Generally speaking, there are two ways for this fundamental question: <code>shared memory</code> and <code>message passing</code>. You’ll see how to do these in Golang based on a case study and some tricky problems around it.</p>
<h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p><code>Golang</code> is a new popular and powerful programming language that aims to provide a simple, efficient, and safe way to build multi-threaded software. </p>
<p>Concurrent programming is one of Go’s main selling points. <code>Go</code> uses a concept called <em>goroutine</em> as its concurrency unit. Goroutine is a complex but interesting topic, you can find many articles about it online, This post will not cover concepts about it in detail. Simply speaking, goroutine is a user-space  level thread which is lightweight and easy to create. </p>
<p>As mentioned above, one of the complicated problems when we do concurrent programming is that inter-thread (or inter-goroutine) communication is very error-prone. In Golang, it provides frameworks for both <code>shared memory</code> and <code>message passing</code>. However, it encourages the use of <em>channels</em> over shared memory. </p>
<p>You’ll see how both of these methods in Golang based on the following case. </p>
<h2 id="Case-study"><a href="#Case-study" class="headerlink" title="Case study"></a>Case study</h2><p>The example is very simple: sums a collection (10 million) of integers. In fact this example is based on this good <a href="https://www.ardanlabs.com/blog/2018/12/scheduling-in-go-part3.html" target="_blank" rel="noopener">article</a>. It used the <code>shared memory</code> way to realize the communication between goroutines. I expand this example and implemented the <code>message passing</code> way to show the difference.</p>
<h3 id="Shared-Memory"><a href="#Shared-Memory" class="headerlink" title="Shared Memory"></a>Shared Memory</h3><p>Go supports traditional shared memory accesses among goroutines. You can use various traditional synchronization primitives such as <em>lock/unlock</em> (Mutex), <em>condition variable</em> (Cond) and <em>atomic</em> read/write operations(atomic).  </p>
<p>In the following implementation, you can see Go uses <code>WaitGroup</code> to allow multiple goroutines to do their tasks before a waiting goroutine. This usage is very similar to <code>pthread_join</code> in C. </p>
<p>Goroutines are added to a WaitGroup by calling <code>Add</code> method. And the goroutines in a WaitGroup call <code>Done</code> method to notify their completion, while a goroutine make a call to <code>Wait</code> method to wait for all goroutines’ completion. </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"math/rand"</span></span><br><span class="line">	<span class="string">"runtime"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">	<span class="string">"sync/atomic"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	numbers := generateList(<span class="number">1e7</span>)</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">"add: "</span>, add(numbers))</span><br><span class="line">	fmt.Println(<span class="string">"add concurrent: "</span>, addConcurrent(runtime.NumCPU(), numbers))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateList</span><span class="params">(totalNumbers <span class="keyword">int</span>)</span> []<span class="title">int</span></span> &#123;</span><br><span class="line">	numbers := <span class="built_in">make</span>([]<span class="keyword">int</span>, totalNumbers)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; totalNumbers; i++ &#123;</span><br><span class="line">		numbers[i] = rand.Intn(totalNumbers)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> numbers</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(numbers []<span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> v <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">for</span> _, n := <span class="keyword">range</span> numbers &#123;</span><br><span class="line">		v += n</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> v</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">addConcurrent</span><span class="params">(goroutines <span class="keyword">int</span>, numbers []<span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> v <span class="keyword">int64</span></span><br><span class="line">	totalNumbers := <span class="built_in">len</span>(numbers)</span><br><span class="line">	lastGoroutine := goroutines - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">	strid := totalNumbers / goroutines</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">	wg.Add(goroutines)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> g := <span class="number">0</span>; g &lt; goroutines; g++ &#123;</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(g <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">			start := g * strid</span><br><span class="line">			end := start + strid</span><br><span class="line">			<span class="keyword">if</span> g == lastGoroutine &#123;</span><br><span class="line">				end = totalNumbers</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">var</span> lv <span class="keyword">int</span></span><br><span class="line">			<span class="keyword">for</span> _, n := <span class="keyword">range</span> numbers[start:end] &#123;</span><br><span class="line">				lv += n</span><br><span class="line">			&#125;</span><br><span class="line">			atomic.AddInt64(&amp;v, <span class="keyword">int64</span>(lv))</span><br><span class="line">			wg.Done()</span><br><span class="line">		&#125;(g)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	wg.Wait()</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">int</span>(v)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In the example above the <code>int64</code> variable <code>v</code> is shared across goroutines. When this variable needs to be updated, an atomic operation was done by calling <code>atomic.AddInt64()</code> method to avoid race condition and nondeterministic result. </p>
<p>That’s how shared memory across goroutines works in Golang. Let’s go to message passing way in next section. </p>
<h3 id="Message-Passing"><a href="#Message-Passing" class="headerlink" title="Message Passing"></a>Message Passing</h3><p>In Golang world, there is one sentence is famous:</p>
<blockquote>
<p>Don’t communicate by sharing memory; share memory by communicating</p>
</blockquote>
<p>For that, <code>Channel</code>(chan) is introduced in Go as a new concurrency primitive to send data across goroutines. This is also the way Golang recommended you to follow.</p>
<p>So the concurrent program to sum 10 million integers  based on <code>Channel</code> goes as below: </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"math/rand"</span></span><br><span class="line">	<span class="string">"runtime"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> result <span class="keyword">int64</span></span><br><span class="line">	numbers := generateList(<span class="number">1e7</span>)</span><br><span class="line"></span><br><span class="line">	goroutines := runtime.NumCPU()</span><br><span class="line">	lastGoroutine := goroutines - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">	totalNumbers := <span class="built_in">len</span>(numbers)</span><br><span class="line">	strid := totalNumbers / goroutines</span><br><span class="line"></span><br><span class="line">	c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> g := <span class="number">0</span>; g &lt; goroutines; g++ &#123;</span><br><span class="line">		start := g * strid</span><br><span class="line">		end := start + strid</span><br><span class="line">		<span class="keyword">if</span> g == lastGoroutine &#123;</span><br><span class="line">			end = totalNumbers</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">go</span> add(numbers[start:end], c)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> l := <span class="keyword">range</span> c &#123;</span><br><span class="line">		result += <span class="keyword">int64</span>(l)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">"add concurrent: "</span>, result)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateList</span><span class="params">(totalNumbers <span class="keyword">int</span>)</span> []<span class="title">int</span></span> &#123;</span><br><span class="line">	numbers := <span class="built_in">make</span>([]<span class="keyword">int</span>, totalNumbers)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; totalNumbers; i++ &#123;</span><br><span class="line">		numbers[i] = rand.Intn(totalNumbers)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> numbers</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(numbers []<span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> v <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">for</span> _, n := <span class="keyword">range</span> numbers &#123;</span><br><span class="line">		v += n</span><br><span class="line">	&#125;</span><br><span class="line">	c &lt;- v</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>To create a typed channel, you can call <code>make</code> method. In this case, since the value we need to pass is an integer, so we create an int type channel with <code>c := make(chan int)</code>. To read and write data to that channel, you can use <code>&lt;-</code> operator. For example, in the <code>add</code> goroutine, when we get the sum of integers, we use <code>c &lt;- v</code> to send data to the channel. </p>
<p>To read data from the channel in the main goroutine, we use a build-in method <code>range</code> in Golang which can iterate through data structure like slice, map and channel. </p>
<p>That’s it. Simple and beautiful. </p>
<h4 id="Hit-the-Deadlock"><a href="#Hit-the-Deadlock" class="headerlink" title="Hit the Deadlock"></a>Hit the Deadlock</h4><p>Let’s build and run the above solution. You’ll get an error message as following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatal error: all goroutines are asleep - deadlock!</span><br></pre></td></tr></table></figure>

<p>The <code>deadlock</code> issue occurs because of these two reasons. Firstly by default sends and receives to a channel are blocking. When a data is send to a channel, the control in that goroutine is blocked at the send statement until some other Goroutine reads from the channel. Similarly when data is read from a channel, the read is blocked until some Goroutine writes data to that channel. Secondly, <code>range</code> only stops when the channel is closed. In this case, each <code>add</code> Goroutine send only one value to the channel but didn’t close the channel. And the main Goroutine keeps waiting for something to be written (in fact, it can read 4 values, but after that it doesn’t stop and keep waiting for more data). So all of the Goroutines are blocked and none of them can continue the execution. Then hit a deadlock. </p>
<h4 id="Fix-the-Deadlock"><a href="#Fix-the-Deadlock" class="headerlink" title="Fix the Deadlock"></a>Fix the Deadlock</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"math/rand"</span></span><br><span class="line">	<span class="string">"runtime"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> result <span class="keyword">int64</span></span><br><span class="line">	numbers := generateList(<span class="number">1e7</span>)</span><br><span class="line"></span><br><span class="line">	goroutines := runtime.NumCPU()</span><br><span class="line">	lastGoroutine := goroutines - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">	totalNumbers := <span class="built_in">len</span>(numbers)</span><br><span class="line">	strid := totalNumbers / goroutines</span><br><span class="line"></span><br><span class="line">	c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> g := <span class="number">0</span>; g &lt; goroutines; g++ &#123;</span><br><span class="line">		start := g * strid</span><br><span class="line">		end := start + strid</span><br><span class="line">		<span class="keyword">if</span> g == lastGoroutine &#123;</span><br><span class="line">			end = totalNumbers</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">go</span> add(numbers[start:end], c)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> j := <span class="number">0</span>; j &lt; goroutines; j++ &#123;</span><br><span class="line">		result += <span class="keyword">int64</span>(&lt;-c)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">"add concurrent: "</span>, result)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateList</span><span class="params">(totalNumbers <span class="keyword">int</span>)</span> []<span class="title">int</span></span> &#123;</span><br><span class="line">	numbers := <span class="built_in">make</span>([]<span class="keyword">int</span>, totalNumbers)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; totalNumbers; i++ &#123;</span><br><span class="line">		numbers[i] = rand.Intn(totalNumbers)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> numbers</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(numbers []<span class="keyword">int</span>, c <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> v <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">for</span> _, n := <span class="keyword">range</span> numbers &#123;</span><br><span class="line">		v += n</span><br><span class="line">	&#125;</span><br><span class="line">	c &lt;- v</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Let use the manual <code>for</code> loop, in each iteration we read the value from the channel and sum together. Run it again. The deadlock is resolved. </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://baoqger.github.io/2020/10/26/golang-concurrent-twoways/" data-id="ckzkmc7jw000f7kmme8gr8f91" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang-concurrent-shared-memory-message-pass/" rel="tag">golang, concurrent, shared memory, message pass</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-os-xv6-1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/22/os-xv6-1/" class="article-date">
  <time datetime="2020-09-22T08:58:18.000Z" itemprop="datePublished">2020-09-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/22/os-xv6-1/">Hack operating system by xv6 project</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h3><p>In this post, I want to introduce <code>xv6</code> which is a “simple, Unix-like operating system”. </p>
<p>xv6 is not only an open-source project, but also it is used for teaching purposes in MIT’s Operating Systems Engineering(6.828) course as well as many other institutions. </p>
<p>If you’re like me, always want to learn operating system, I guess you’ll face a very steep learning curve since operating system is complex. </p>
<p>For learning purpose, we need an operating system project which is <code>not too complex</code> and <code>not  too simple</code>. Luckily, xv6 is just for this purpose which is simple enough to follow up as an open source project, yet still contains the important concepts and organization of Unix. </p>
<h3 id="Resource"><a href="#Resource" class="headerlink" title="Resource"></a>Resource</h3><p>Since <code>xv6</code> is an open source project, you can easily find many resources online. </p>
<p>Personally I recommend to use this <a href="https://pdos.csail.mit.edu/6.828/2020/schedule.html" target="_blank" rel="noopener">page</a>, which is the latest teaching resource for the corresponding MIT course. You can find source code, examples, slides and videos there. Very helpful!</p>
<h3 id="Environment-setup-for-xv6-project"><a href="#Environment-setup-for-xv6-project" class="headerlink" title="Environment setup for xv6 project"></a>Environment setup for xv6 project</h3><p>On the MIT course’s document, there are many solutions for setting up the xv6 development environment. You can follow those solutions, it will work. </p>
<p>For your convenience, I make a <code>Dockerfile</code> to build the docker image which contains all the necessary dependencies to keep working on xv6. The Dockerfile goes as following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu:latest</span><br><span class="line"></span><br><span class="line">ARG DEBIAN_FRONTEND&#x3D;noninteractive</span><br><span class="line"></span><br><span class="line">RUN apt-get -qq update</span><br><span class="line"></span><br><span class="line">RUN apt-get install -y git \</span><br><span class="line">                    build-essential \</span><br><span class="line">                    gdb-multiarch \</span><br><span class="line">                    qemu-system-misc \</span><br><span class="line">                    gcc-9-riscv64-linux-gnu \</span><br><span class="line">                    gcc-riscv64-linux-gnu \</span><br><span class="line">                    binutils-riscv64-linux-gnu\</span><br><span class="line">                    tmux \</span><br><span class="line">                    qemu</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="https://baoqger.github.io/2020/09/22/os-xv6-1/" data-id="ckzkmc7kd001s7kmm0cbxf6x5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/operating-system-xv6-Unix/" rel="tag">operating system, xv6, Unix</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-stack-frame" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/19/stack-frame/" class="article-date">
  <time datetime="2020-08-18T20:54:00.000Z" itemprop="datePublished">2020-08-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/19/stack-frame/">Understand stack memory management</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Table-of-Contents"><a href="#Table-of-Contents" class="headerlink" title="Table of Contents"></a>Table of Contents</h3><p>First I have to admit that memory management is a big( and important) topic in operating system. This post can’t cover everything related to it. </p>
<p>In this post, I want to share something interesting I learned about stack memory management. Especially understand how the stack frame of function call works, which’s the most important part of stack memory. I will explain the mechanism in detail with examples and diagrams.</p>
<p>Briefly speaking, the contents of this post is:</p>
<ul>
<li>Memory layout of a process</li>
<li>Stack memory contents</li>
<li>CPU register related to stack memory management</li>
<li>Stack frame of function call and return mechanism</li>
</ul>
<p>To understand the concepts and machanisms deeply, a few assembly code will be shown in this post, you don’t have to know assembly lauguage as an expert for reading this post, I will add comments for these assembly codes to make explain what’s their functionalities.</p>
<h3 id="Stack-Memory-Management-Basic"><a href="#Stack-Memory-Management-Basic" class="headerlink" title="Stack Memory Management Basic"></a>Stack Memory Management Basic</h3><h4 id="Memory-Layout-of-Process"><a href="#Memory-Layout-of-Process" class="headerlink" title="Memory Layout of Process"></a>Memory Layout of Process</h4><p>Before we talk about Stack memory management, it’s necessary to understand <code>memory layout</code> of a process.</p>
<p>When you create a program, it is just some Bytes of data which is stored in the disk. When a program executes then it starts loading into memory and become a live entity. In a more specify way, some memory (virtual memory) is allocated to each process in execution for its usage by operating system. The memory assigned to a process is called process’s <code>virtual address space</code>( short for VAS). And memory layout use diagrams to help you understand the concept of process virtual address space easily.</p>
<p>There are some awesome posts on the internet about <a href="https://www.includehelp.com/operating-systems/memory-layout-of-a-process.aspx" target="_blank" rel="noopener">memory layout</a>. And the most two critical sections are: Stack and Heap. Simply speaking, <code>Stack</code> is the memory area which is used by each process to store the local variables, passed arguments and other information when a function is called. This is the topic of this post, you’ll know more detailed in the following sections. While <code>Heap</code> segment is the one which is used for dynamic memory allocation, this is another more complex topic out of this post’s scope. </p>
<h4 id="Stack-Memory-Basics"><a href="#Stack-Memory-Basics" class="headerlink" title="Stack Memory Basics"></a>Stack Memory Basics</h4><p>Stack Memory is just memory region in each process’s virtual address space where <code>stack</code> data structure (Last in, first out) is used to store the data. As we mentioned above, when a new function call is invoked, then a frame of data is pushed to stack memory and when the function call returns then the frame is removed from the stack memory. This is <strong>Stack Frame</strong> which represent a function call and its argument data. And every function has its own stack frame.</p>
<p>Let’s say in your program there are multiple functions call each other in order. For example, <code>main() -&gt; f1() -&gt; f2() -&gt; f3()</code>, <code>main</code> function calls function one <code>f1()</code>, then function one calls function two <code>f2()</code>, finally function two calls function three <code>f3()</code>. So based on the Last in first out rule, the stack memory will be like as below: </p>
<p><img src="/images/stack_frames.png" alt="stack-frame"></p>
<p><strong>Note</strong>: the top of the stack is the bottom part of the image. Don’t feel confused for that. </p>
<h4 id="Stack-memory-contents"><a href="#Stack-memory-contents" class="headerlink" title="Stack memory contents"></a>Stack memory contents</h4><p>After understand stack frames, now let’s dive deep into each stack frame to discover its contents.</p>
<p>Each stack frame contains 4 parts:</p>
<ul>
<li>Parameter passed to the callee function</li>
<li>Return address of the caller function</li>
<li>Base pointer</li>
<li>Local variables of the callee function</li>
</ul>
<p><img src="/images/stack_contents.png" alt="stack-contents"></p>
<p>Caller and callee is very easy to understand. Let’s say <code>main() -&gt; f1()</code>, then caller function is <code>main()</code> while callee function is <code>f1()</code>. Right? </p>
<p>For the above 4 four parts, there are something need to emphasis. Firstly the size of <code>return address of the caller function</code> is fixed, for example, in 32 bits system the size is 4B. And <code>Base pointer</code> size is fixed as well, it’s also 4B in a 32 bits system. This fixed size is important, you’ll see the reason in following sections. </p>
<p>Next, in the above diagram you see two kinds of pointers: <strong>base pointer</strong> and <strong>stack pointer</strong>. Let’s check them one by one.</p>
<p><strong><em>Stack pointer</em></strong>: pointer to the top of the stack. When stack adds or removes data then stack pointer will change correspondingly. Stack pointer is straight forward and not difficult to understand, right?<br><strong><em>Base pointer</em></strong>: is also called <code>frame pointer</code> which points to the current active  frame. And the current active frame is the topmost frame of the stack. </p>
<p>The base pointer is conventionlly used to mark the start of a function’s stack frame, and the area of the stack managed by that function. As we mentioned above, since the size of return address and base pointer is fixed, so based on the address of base pointer you can get all the data in that stack frame. Local variables can be accessed with positive offset and passed parameters can be got with negative offset. That’s the reason why it is called <strong>base</strong> pointer. Great design, right? </p>
<p>The other thing need to discuss is what’t the content of base pointer part in each stack frame? In the above diagram you see that a 4 bytes data is pushed into the stack, we call it base pointer. But what’s the data? In fact, base pointer is designed to <code>store the caller&#39;s base pointer address</code>. This is also a smart design to make function return works well. We’ll discuss more about it later.</p>
<h4 id="CPU-register"><a href="#CPU-register" class="headerlink" title="CPU register"></a>CPU register</h4><p>To understand stack memory management, you’ll need to know 3 interesting CPU register:</p>
<ul>
<li><strong>eip</strong>: Instruction pointer register which stores the address of the next instruction to be run. </li>
<li><strong>esp</strong>: Stack pointer register which stores the address of the top of the stack at any time.</li>
<li><strong>ebp</strong>: Base pointer register which stores base pointer address of callee’s stack frame.  And the content at this address is the caller’s base pointer value (we already mentioned this point above).</li>
</ul>
<p>Until now, you see all the necessary stuff: stack frame, stack frame content and CPU registers. Let’s see how they play together to make stack frames of function call and return works. You’ll see how this simple but beautiful design realizes such a complex task.  </p>
<h3 id="Mechanism-of-function-call-and-return"><a href="#Mechanism-of-function-call-and-return" class="headerlink" title="Mechanism of function call and return"></a>Mechanism of function call and return</h3><p>In this section, you’ll understand how function call and return works by reading a few assembly codes (which are not difficult to understand).</p>
<h4 id="function-call"><a href="#function-call" class="headerlink" title="function call"></a>function call</h4><p><strong>Step one</strong>: as you already see in the above diagram the first part of each stack frame is the passed parameters to the callee. So all the arguments are pushed on the stack as the following codes shows:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">push arg2;</span><br><span class="line">push arg1;</span><br></pre></td></tr></table></figure>

<p><code>push</code> is the assembly instruction to push data onto the stack. And usually the arguments are pushed to the stack in the reverse order that they’re declared in function.</p>
<p><strong>Step two</strong>: the second part is the <code>Return address of the caller fn</code>, so we need to push the address of next instruction in caller function as <code>Return address</code> in callee’s stack frame. As we introduced in the last section, the address of next instruction will be stored in <code>EIP</code> register, right? The assembly code goes as following: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">push eip;</span><br></pre></td></tr></table></figure>

<p><strong>Step three</strong>: upon entrying to the callee function, the old <code>EBP</code> value (the caller function’s base pointer address) is pushed onto the stack and then <code>EBP</code> is set to the value of <code>ESP</code>. Then the <code>ESP</code> is decremented (since the stack grows downward in stack memory) to allocate space for the local variables. And the codes goes as following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">push ebp;</span><br><span class="line">mov ebp esp;</span><br></pre></td></tr></table></figure>
<p><code>mov</code> - the mov instruction copies the data item referred to by its second operand into the location referred to by its first operand. </p>
<p>So <code>mov %ebp %esp</code> just means set <code>EBP</code> a new value of <code>ESP</code>. Please note that, <code>ESP</code> value changes when data is pushed or popped onto/from the stack. But it’s always points to the top of the stack. Before this <code>mov %ebp %esp</code> instruction, <code>ESP</code> is pointing to the address just after the <code>return address of the caller</code>, and it should be the address of callee’s base pointer and just what <code>EBP</code> should store, this instruction makes sense, right?</p>
<p>From that on, during the execution of the callee function, the passed arguments to the function are located at the positive offsets from <code>EBP</code>, and the local variables are located at the negative offsets from <code>EBP</code>, you already see this conclusion above.</p>
<p>Inside a function, the stack would look like this: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">| &lt;argument 2&gt;       |</span><br><span class="line">| &lt;argument 1&gt;       |</span><br><span class="line">| &lt;return address&gt;   |</span><br><span class="line">| &lt;old ebp&gt;          | &lt;&#x3D; %ebp</span><br><span class="line">| &lt;local var 1&gt;      |</span><br><span class="line">| &lt;local var 2&gt;      | &lt;&#x3D; %esp</span><br></pre></td></tr></table></figure>

<h4 id="function-return"><a href="#function-return" class="headerlink" title="function return"></a>function return</h4><p><strong>Step one</strong>: upon exit from the callee function, all the function has to do is set <code>ESP</code> to the value of <code>EBP</code>. In this way can simply deallocates/releases the local variables from the stack. And then it can also expose callee’s base pointer on the top of the stack for next step operation.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov esp, ebp;</span><br></pre></td></tr></table></figure>

<p>This instruction is restoring the saved value of <code>ESP</code> upon entering the function, at that point what we did is <code>mov ebp esp</code>. Smart design, right?</p>
<p><strong>Step two</strong>: since <code>ESP</code> already reset to the address of base pointer, next step we can simply pop the old <code>EBP</code> value from the top of stack as following: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pop ebp;</span><br></pre></td></tr></table></figure>

<p><code>pop</code> instruction retrieves the topmost value from the stack and puts the value into the second operand, in this case is <code>EBP</code>. Remember the <code>callee</code> function’s base pointer stores the <code>caller</code> function’s base pointer, so this simple <code>pop ebp</code> instruction realize EBP register restore perfactly. Great design, right?</p>
<p><strong>Step three</strong>: next is straight forward, we need to pop the caller function return address to <code>EIP</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pop eip;</span><br></pre></td></tr></table></figure>

<p>Similar to step two, right? Now the system knows the next instruction (pointing to the return address in the caller function) need to run. The execution context is giving back to the caller function. </p>
<p>Upon returning back to the caller function, it can then increase <code>ESP</code> register again to remove the passed function arguments it pushed onto the stack. At this point, the stack frames becomes the same as it was in prior to invoking the callee function. </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://baoqger.github.io/2020/08/19/stack-frame/" data-id="ckzkmc7ke001x7kmm2rmsbaqn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/memory-management-stack/" rel="tag">memory management, stack</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-linux-cpp-docker" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/28/linux-cpp-docker/" class="article-date">
  <time datetime="2020-07-28T12:42:21.000Z" itemprop="datePublished">2020-07-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/28/linux-cpp-docker/">Use Docker container for local C++ development</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Why-develop-in-Docker-container"><a href="#Why-develop-in-Docker-container" class="headerlink" title="Why develop in Docker container?"></a>Why develop in Docker container?</h3><p><code>Docker</code> is the hottest technology to deploy and run the software. The key benefit of Docker is that it allows users to package an application with all of its dependencies into a standardized unit for software development. Compared with virtual machines, containers do not have high overhead and hence enable more efficient usage of the underlying system and resources. </p>
<p>Besides deploying and running applications, Docker containers can also make your local development work easier, especially when you need to set up a specific environment with many dependencies. </p>
<p>In my case, I have a project which is a C++ application running on the Linux platform. But on personal machines I’m running macOS and Windows systems, I didn’t install Linux platform on my computer. Before I start working on this project, I need to fix the platform/environment issue. </p>
<p>The first idea is, of course, using virtual-machines with VirtualBox and install the Linux system in it. This process will be time-consuming and tedious. So I decided to use Docker container to speed up the environment configuration step. </p>
<p>I will share the experience step by step. The whole process is lightweight and quick, also can practice your Docker related skills.</p>
<h3 id="Create-the-Docker-container"><a href="#Create-the-Docker-container" class="headerlink" title="Create the Docker container"></a>Create the Docker container</h3><p>To build a Docker image, we need a <code>Dockerfile</code>, which is a text document(without a file extension) that contains the instructions to set up an environment for a Docker container. The Docker <a href="https://docs.docker.com/get-started/overview/" target="_blank" rel="noopener">official site</a> is the best place to understand those fundamental and important knowledge.</p>
<p>In my case the basic <code>Dockerfile</code> goes as following:</p>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Download base image ubuntu 20.04</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Disable Prompt During Packages Installation</span></span><br><span class="line"><span class="keyword">ARG</span> DEBIAN_FRONTEND=noninteractive</span><br><span class="line"></span><br><span class="line"><span class="comment"># Update Ubuntu Software repository</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y \</span></span><br><span class="line"><span class="bash">    make \</span></span><br><span class="line"><span class="bash">    cmake \</span></span><br><span class="line"><span class="bash">    g++ \</span></span><br><span class="line"><span class="bash">    libncurses5-dev \</span></span><br><span class="line"><span class="bash">    libncursesw5-dev \</span></span><br><span class="line"><span class="bash">&amp;&amp; rm -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"bash"</span>]</span></span><br></pre></td></tr></table></figure>

<p><strong><em>FROM</em></strong> : the first part is the <code>FROM</code> command, which tells us what image to base this off of (as we know, Docker is following a multi-layer structure). In my case,  it’s using the <code>Ubuntu:20.04</code> image, which again references a Dockerfile to automate the process. </p>
<p><strong><em>ARG</em></strong>: <code>ARG</code> instruction defines a variable that can be passed at build time to pass environment info. In this case, just to disable the console output during the following Linux package installation process. </p>
<p><strong><em>RUN</em></strong>: the next set of calls are the <code>RUN</code> commands. This <code>RUN</code> instruction allows you to install your application and packages for it. <code>RUN</code> executes commands in a new layer and creates a new layer by committing the results. Usually, you can find several <code>RUN</code> instructions in a Dockerfile. In this case, I want to install the C++ compiler and build tools (and some other specific dependency packages for development) which is not available in the Ubuntu base image.</p>
<p><strong><em>CMD</em></strong>: the last instruction <code>CMD</code> allows you to set a default command, which will be executed when you run the container without specifying a command. If Docker container runs with a command, this default one will be ignored. </p>
<p>With this <code>Dockerfile</code>, we can build the image with the next Docker command:</p>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t linux-cpp .</span><br></pre></td></tr></table></figure>

<p>This will build the desired Docker image tagged as <code>linux-cpp</code>. You can list(find) this new image in your system with command <code>docker images</code>: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">linux-cpp           latest              5463808c4488        8 days ago          320MB</span><br></pre></td></tr></table></figure>

<p>Now you can run the docker container with the newly build <code>linux-cpp</code> image:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --name cpp-dev --rm linux-cpp</span><br></pre></td></tr></table></figure>

<h3 id="Mount-source-code-into-container"><a href="#Mount-source-code-into-container" class="headerlink" title="Mount source code into container"></a>Mount source code into container</h3><p>Follow the above steps, you can have a running Docker container with C++ development dependencies in Linux environment. </p>
<p>Next, you can directly start your C++ program inside the container, then build and run your code. </p>
<p>But if you just put your program inside the container, you will have a high risk to lose your code when the container is deleted. </p>
<p>The better way is placing your program source code on your local machine and sync the codes into the container as you program. This is where <code>mount</code> can help you. Mount and Volume is an important topic for Docker, you can find <a href="https://docs.docker.com/storage/bind-mounts/" target="_blank" rel="noopener">some posts</a> for deeper introduction. </p>
<p>In my case, I can realize my target with the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --name cpp-dev  --rm  -v <span class="variable">$&#123;PWD&#125;</span>:/develop  linux-cpp</span><br></pre></td></tr></table></figure>

<p>the key and interesting part is: <code>-v ${PWD}:/develop</code>,  this will mount the current directory of the host machine into the <code>develop</code> directory inside the container. If <code>develop</code> directory is not there, Docker will make it for you. </p>
<p><strong><em>Note</em></strong>: the current directory <code>pwd</code> command’s usage has some variants based on your host machine. The above command works for the <code>Powershell</code> of Windows, if you are using <code>git bash</code> on Windows, please try: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-v /$(<span class="built_in">pwd</span>):/develop</span><br></pre></td></tr></table></figure>

<p>For Mac users, try the following: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-v $(<span class="built_in">pwd</span>):/develop</span><br></pre></td></tr></table></figure>

<p>Now you can happily code your program in your familiar host machine, save the code change and sync them into the container. Then build and run your code inside the container with every dependency it needs. </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://baoqger.github.io/2020/07/28/linux-cpp-docker/" data-id="ckzkmc7kb001k7kmm2ybi2p32" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker-c-linux/" rel="tag">docker, c++, linux</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-memoizedSelector" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/20/memoizedSelector/" class="article-date">
  <time datetime="2020-04-20T12:15:50.000Z" itemprop="datePublished">2020-04-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/20/memoizedSelector/">Understand NgRx memoizedSelector in source code level</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h3><p><code>Selector</code> is an essential part of the entire NgRx state management system, which is much more complicated than the <code>action</code> and <code>reducer</code> part based on my learning and development experience. Sometimes I feel it is like a black box, which hides many excellent designs and techniques. I spend some time and dig into the source code of NgRx to take a look at the internals of the black box. This post (and later posts) will share some interesting points I found during the process. </p>
<p>When using NgRx, developers always do something like this: </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> animalListState: MemoizedSelector&lt;State, Animal[]&gt; = createSelector(</span><br><span class="line">  rootState,</span><br><span class="line">  (state: RootState): <span class="function"><span class="params">AnimalListState</span> =&gt;</span> state.animalList</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><code>createSelector</code> method return a selector function, which can be passed into the <code>store.select()</code> method to get the desired state out of the store. </p>
<p>By default, the type of the returned function from <code>createSelector</code> is <code>MemoizedSelector&lt;State, Result&gt;</code>. Have you ever notice that? This post will introduce what it is and how it works. </p>
<h3 id="What-is-memoization"><a href="#What-is-memoization" class="headerlink" title="What is memoization?"></a>What is memoization?</h3><p>Memoization is a general concept in computer science. Wikipedia explains it as follows: </p>
<blockquote>
<p>In computing, memoization or memoisation is an optimization technique used primarily to speed up computer programs by storing the results of expensive function calls and returning the cached result when the same inputs occur again. </p>
</blockquote>
<p>You can find <a href="https://dev.to/carlillo/understanding-javascripttypescript-memoization-o7k" target="_blank" rel="noopener">many articles</a> online for explaining memoization with code examples. Simply speaking, a hash map is used for the cached result. Technically it’s not difficult at all. </p>
<p>Memoization is a great optimization solution of pure function. Generally speaking, <code>A pure function is a function where the return value is only determined by its input values, without side effects</code>.</p>
<p>As you may know, <code>Selector</code> is a pure function. <code>memoizedSelector</code> is just a normal selector function with memoization optimization. Next, let’s see how it works in the design of the NgRx library.</p>
<h3 id="Source-code-of-memoizedSelector"><a href="#Source-code-of-memoizedSelector" class="headerlink" title="Source code of memoizedSelector"></a>Source code of memoizedSelector</h3><p>In the source code of <a href="https://github.com/ngrx/platform/blob/master/modules/store/src/selector.ts" target="_blank" rel="noopener"><code>NgRx</code></a>, you can find the <code>selector</code> related code in the path of <code>platform/modules/store/src/selector.ts</code>.  </p>
<p><code>selector.ts</code> file is roughly 700 lines, which hold all the functionalities of it. There are many interesting points inside this module, which I can share in another article, but this post focus on memoization. So I pick up all the necessary code and put it as follows: </p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> AnyFn = <span class="function">(<span class="params">...args: <span class="built_in">any</span>[]</span>) =&gt;</span> <span class="built_in">any</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> ComparatorFn = <span class="function">(<span class="params">a: <span class="built_in">any</span>, b: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">boolean</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> MemoizedProjection = &#123;</span><br><span class="line">    memoized: AnyFn;</span><br><span class="line">    reset: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">    setResult: <span class="function">(<span class="params">result?: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">isEqualCheck</span>(<span class="params">a: <span class="built_in">any</span>, b: <span class="built_in">any</span></span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a === b;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isArgumentsChanged</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    args: IArguments,</span></span></span><br><span class="line"><span class="function"><span class="params">    lastArguments:IArguments,</span></span></span><br><span class="line"><span class="function"><span class="params">    comparator: ComparatorFn</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; args.length ; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!comparator(args[i], lastArguments[i])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">defaultMemoize</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    projectionFn: AnyFn,</span></span></span><br><span class="line"><span class="function"><span class="params">    isArgumentsEuqal = isEqualCheck,</span></span></span><br><span class="line"><span class="function"><span class="params">    isResultEqual = isEqualCheck</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">MemoizedProjection</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> lastArguments: <span class="literal">null</span> | IArguments = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> lastResult: <span class="built_in">any</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> overrideResult: <span class="built_in">any</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">reset</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        lastArguments = <span class="literal">null</span>;</span><br><span class="line">        lastResult = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setResult</span>(<span class="params">result: <span class="built_in">any</span> = <span class="literal">undefined</span></span>) </span>&#123;</span><br><span class="line">        overrideResult = result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">memoized</span>(<span class="params"></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (overrideResult !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> overrideResult;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">if</span> (!lastArguments) &#123;</span><br><span class="line">            lastResult = projectionFn.apply(<span class="literal">null</span>, <span class="built_in">arguments</span> <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">            lastArguments = <span class="built_in">arguments</span>;</span><br><span class="line">            <span class="keyword">return</span> lastResult;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!isArgumentsChanged(<span class="built_in">arguments</span>, lastArguments, isArgumentsEuqal)) &#123;</span><br><span class="line">            <span class="keyword">return</span> lastResult;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> newResult = projectionFn.apply(<span class="literal">null</span>, <span class="built_in">arguments</span> <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">        lastArguments = <span class="built_in">arguments</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isResultEqual(lastResult, newResult)) &#123;</span><br><span class="line">            <span class="keyword">return</span> lastResult;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastResult = newResult;</span><br><span class="line">        <span class="keyword">return</span> newResult;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123; memoized, reset, setResult&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>There are many interesting Typescript stuff in the above code block. But for memoization, you can focus on the method <code>defaultMemoize</code>. In the following section, I will show you how it can make your program run faster. </p>
<h3 id="Explore-the-memoizedSelector-method"><a href="#Explore-the-memoizedSelector-method" class="headerlink" title="Explore the memoizedSelector method"></a>Explore the memoizedSelector method</h3><p>To show how memoization works, I create a simple method <code>slowFunction</code> as following, to simulate that a method running very slowly:  </p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">slowFunction</span>(<span class="params">val: <span class="built_in">number</span></span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> pre = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> now = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">        <span class="keyword">if</span> (now.valueOf() - pre.valueOf() &gt; <span class="number">2000</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And then test it with the following scripts: </p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defaultMemoize &#125; <span class="keyword">from</span> <span class="string">"./memoizedSelector"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; slowFunction &#125; <span class="keyword">from</span> <span class="string">"./slowFunction"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// run slowFunction without memoization</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"First call of slowFunction(2)"</span>);</span><br><span class="line"><span class="keyword">let</span> pre = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">slowFunction(<span class="number">2</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"It takes"</span> + ((<span class="keyword">new</span> <span class="built_in">Date</span>()).valueOf() - pre.valueOf())/<span class="number">1000</span> +  <span class="string">"seconds \n"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Second call of slowFunction(2)"</span>);</span><br><span class="line">pre = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">slowFunction(<span class="number">2</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"It takes"</span> + ((<span class="keyword">new</span> <span class="built_in">Date</span>()).valueOf() - pre.valueOf())/<span class="number">1000</span> +  <span class="string">"seconds \n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// run slowFunction with memoization</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fastFunction = defaultMemoize(slowFunction);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"First call of fastFunction(2)"</span>);</span><br><span class="line">pre = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">fastFunction.memoized(<span class="number">2</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"It takes"</span> + ((<span class="keyword">new</span> <span class="built_in">Date</span>()).valueOf() - pre.valueOf())/<span class="number">1000</span> +  <span class="string">"seconds \n"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Second call of fastFunction(2)"</span>);</span><br><span class="line">pre = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">fastFunction.memoized(<span class="number">2</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"It takes"</span> + ((<span class="keyword">new</span> <span class="built_in">Date</span>()).valueOf() - pre.valueOf())/<span class="number">1000</span> +  <span class="string">"seconds \n"</span>);</span><br></pre></td></tr></table></figure>
<p>The output goes as folllowing:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ ts-node index.ts</span><br><span class="line">First call of slowFunction(2)</span><br><span class="line">It takes2.001seconds</span><br><span class="line"></span><br><span class="line">Second call of slowFunction(2)</span><br><span class="line">It takes2.001seconds</span><br><span class="line"></span><br><span class="line">First call of fastFunction(2)</span><br><span class="line">It takes2.002seconds</span><br><span class="line"></span><br><span class="line">Second call of fastFunction(2)</span><br><span class="line">It takes0.001seconds</span><br></pre></td></tr></table></figure>

<p>Compared with the original <code>slowFunction</code> method, the memoized method <code>fastFunction</code> can directly output the result for the same input. That’s the power of memoization, hope you can master it. </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://baoqger.github.io/2020/04/20/memoizedSelector/" data-id="ckzkmc7kc001q7kmm8w6hbzwu" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-rxjs-marble-testing" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/12/rxjs-marble-testing/" class="article-date">
  <time datetime="2020-04-12T12:08:45.000Z" itemprop="datePublished">2020-04-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/12/rxjs-marble-testing/">Typical usage case of Marble Testing for RxJS</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="What’s-Marble-Testing"><a href="#What’s-Marble-Testing" class="headerlink" title="What’s Marble Testing"></a>What’s Marble Testing</h3><p>RxJS is a powerful tool to handle various asynchronous tasks. Sometime RxJS observables are hard to test. In the community, there is one particular unit testing solution for RxJS observables called marble testing.</p>
<p>For marble testing, you can refer to <a href="https://medium.com/@bencabanes/marble-testing-observable-introduction-1f5ad39231c" target="_blank" rel="noopener">these articles</a>. They all do an excellent job of introducing what it is. </p>
<h3 id="A-real-case-to-show-Marble-Testing’s-power"><a href="#A-real-case-to-show-Marble-Testing’s-power" class="headerlink" title="A real case to show Marble Testing’s power"></a>A real case to show Marble Testing’s power</h3><p>Recently in my development work, I came across a case where I used marble testing properly to solve the issue. </p>
<p>The background is for my application in the root <code>index.html</code> file, there is one third-party javascript library/SDK. For some business reasons, after the third-party library is loaded, we bind some value to the global <code>window</code> object. </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.onSecretLibraryLoad = <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">window</span>.SecretLibrary = res; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Before the loaded event is triggered, the <code>window.SecretLibary</code> was <code>undefiend</code>. After the event is triggered, it will be assigned some value. </p>
<p>This global value is vital for my application since one of the UI components depends on it to determine to show or hide. </p>
<p>Since the script was loaded with <code>async</code> flag for performance consideration, this component needs to check the <code>window.SecretLibrary</code> value repeatedly. </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">UIComponent</span> <span class="title">implements</span> <span class="title">OnInit</span> </span>&#123;</span><br><span class="line">    public isSecretLibraryReady$: Observable&lt;boolean&gt;;</span><br><span class="line">    public ngOnInit(): <span class="keyword">void</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.isSecretLibraryReady$ = <span class="keyword">this</span>.getSecretLibraryLoadStatus();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public getSecretLibraryLoadStatus(): Observable&lt;boolean&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> timer(<span class="number">0</span>, <span class="number">500</span>).pipe(</span><br><span class="line">            map(<span class="function">(<span class="params">t</span>) =&gt;</span> (&#123;</span><br><span class="line">                currentTimeTick: t,</span><br><span class="line">                isReady: <span class="built_in">Boolean</span>((<span class="built_in">window</span> <span class="keyword">as</span> any).SecretLibrary)</span><br><span class="line">            &#125;)),</span><br><span class="line">            takeWhile(</span><br><span class="line">                (val) =&gt; !val.isReady &amp;&amp; val.currentTimeTick &lt;= <span class="number">30000</span>/<span class="number">500</span>,</span><br><span class="line">                <span class="literal">true</span></span><br><span class="line">            ),</span><br><span class="line">            pluck(<span class="string">"isReady"</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The interesting part comes from the <code>getSecretLibraryLoadStatus</code> function. It utilizes the <code>timer</code>, <code>map</code>, <code>takeWhile</code>, and <code>pluck</code> operators of RxJS library to realize the repeatedly status checking and updating purpose. </p>
<p>RxJS operator is not this article’s topic, so I will not dig deep into it. Just add one comment for the <code>takeWhile</code> part, which seems a little hard to understand at the first look. It defines two conditions to stop the observable: first case is the <code>window.SecretLibrary</code> value is not undefined, which means the script is loaded; the second case is it reaches the maximum time limit (30 seconds). </p>
<h3 id="How-to-test-it-marble-testing"><a href="#How-to-test-it-marble-testing" class="headerlink" title="How to test it: marble testing"></a>How to test it: marble testing</h3><p>Traditionally we use <code>subscribe and assert</code> pattern to test RxJS observables. But for the case, as mentioned above: time-based observables, the traditional solution can’t handle it well. We can’t wait 30 seconds when we run the unit tests during local development or in CI pipeline. That’s unacceptable.</p>
<p>Marble testing can fix this issue correctly by the concept of virtual time. For what is virtual time, you can refer to <a href="https://medium.com/angular-in-depth/how-to-test-observables-a00038c7faad" target="_blank" rel="noopener">these great articles</a>. I will not discuss it at a detailed level in this post. Simply speaking, virtual time empowers us to test asynchronous RxJS observable synchronously. In virtual time asynchronous functions like <code>setTimeout</code> and <code>setInterval</code> will use fake time instead of actual time. And the magic comes from the <code>TestScheduler</code> of RxJS. </p>
<p>The marble testing solution as following: </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">"UIComponent"</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> component: UIComponent;</span><br><span class="line">  <span class="keyword">let</span> fixture: ComponentFixture&lt;UIComponent&gt;;</span><br><span class="line">  <span class="keyword">let</span> scheduler: TestScheduler;</span><br><span class="line"></span><br><span class="line">  beforeEach(<span class="keyword">async</span>(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    TestBed.configureTestingModule(&#123;</span><br><span class="line">      declarations: [UIComponent],</span><br><span class="line">    &#125;).compileComponents();</span><br><span class="line">  &#125;));</span><br><span class="line"></span><br><span class="line">  beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    fixture = TestBed.createComponent(UIComponent);</span><br><span class="line">    component = fixture.componentInstance;</span><br><span class="line">    scheduler = <span class="keyword">new</span> TestScheduler(<span class="function">(<span class="params">actual, expected</span>) =&gt;</span> expect(actual).toEqual(expected));</span><br><span class="line">    (<span class="built_in">window</span> <span class="keyword">as</span> any).SecretLibrary = <span class="literal">undefined</span>;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">"getSecretLibraryLoadStatus method should return a boolean observable stream, for script load success case"</span>, () =&gt; &#123;</span><br><span class="line">    scheduler.run(<span class="function">(<span class="params">&#123; expectObservable &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      timer(<span class="number">2</span> * <span class="number">1000</span>).subscribe(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        (<span class="built_in">window</span> <span class="keyword">as</span> any).SecretLibrary = <span class="string">"SecretLibrary"</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="comment">// tricky point about marble test: a, b, c these placeholders account 1 frame of virtual time</span></span><br><span class="line">      expectObservable(component.getSecretLibraryLoadStatus()).toBe(</span><br><span class="line">        <span class="string">"a 499ms b 499ms c 499ms d 499ms (e|)"</span>,</span><br><span class="line">        &#123;</span><br><span class="line">          a: <span class="literal">false</span>,</span><br><span class="line">          b: <span class="literal">false</span>,</span><br><span class="line">          c: <span class="literal">false</span>,</span><br><span class="line">          d: <span class="literal">false</span>,</span><br><span class="line">          e: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      );</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Let me emphasize several key points to understand the above testing case. <code>getSecretLibraryLoadStatus</code> will repeatedly check the status of <code>window.SecretLibrary</code> every 500 milliseconds and return a boolean value stream. </p>
<p>I manually set the <code>window.SecretLibrary</code> value after 2 seconds by calling this: </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">timer(<span class="number">2</span> * <span class="number">1000</span>).subscribe(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  (<span class="built_in">window</span> <span class="keyword">as</span> any).SecretLibrary = <span class="string">"SecretLibrary"</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>So Let’s imagine what the result should be: the first four emit value will be <code>false</code>,  and the last value is <code>true</code>. That’s the expected observable. </p>
<p>But please notice that <code>scheduler.run</code>, everything run inside the callback will use virtual time. So we didn’t wait 2 seconds for the <code>timer</code> operator. Instead, it runs synchronously. </p>
<p>The second point needs to notice is the syntax of the marble string <code>a 499ms b 499ms c 499ms d 499ms (e|)</code>. Yes, it looks a little wired, but be careful that’s the correct way to represent marble. <strong>The alphanumeric values represent an actual emitted value, which advances time one virtual frame</strong>.</p>
<p>Here I only show the case where the third-party script load successfully. Of course, to have full testing coverage, we need to consider the negative case where the script failed to load. You can figure it out. </p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>In this post, I didn’t go into the detailed syntax of marble testing. I think the reader can find the related document easily. I record a real usage case in the development where marble testing can show its power to handle async observables. </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://baoqger.github.io/2020/04/12/rxjs-marble-testing/" data-id="ckzkmc7kd001u7kmm731716dm" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/5/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Best-practice/" rel="tag">Best practice,</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fabio-Golang-Source-code/" rel="tag">Fabio, Golang, Source code</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Golang-bufio-bytes-buffer/" rel="tag">Golang, bufio, bytes, buffer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Golang-package-workspace-vendor/" rel="tag">Golang, package, workspace, vendor</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP-protocol-Golang-TCP-socket/" rel="tag">HTTP protocol, Golang, TCP, socket</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP-system-call-Linux-Golang/" rel="tag">HTTP, system call, Linux, Golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP-1-1-concurrent/" rel="tag">HTTP/1.1, concurrent</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP-1-1-persistent-connection-keep-alive-TCP-netstat-tcpdump-Golang-connection-pool/" rel="tag">HTTP/1.1, persistent connection, keep-alive, TCP, netstat, tcpdump, Golang, connection pool</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTPS-TLS-handshake-SSL-TLS/" rel="tag">HTTPS, TLS handshake, SSL/TLS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-system-programming-Windows-Subsystem-for-Linux/" rel="tag">Linux, system programming, Windows Subsystem for Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TCP-IP/" rel="tag">TCP, IP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/apt-Ubuntu-Linux-package-management/" rel="tag">apt, Ubuntu, Linux, package management</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/certificate-digital-signature-hashing/" rel="tag">certificate, digital signature, hashing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/digital-signature-hash-function/" rel="tag">digital signature, hash function</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker-c-linux/" rel="tag">docker, c++, linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang-concurrent-shared-memory-message-pass/" rel="tag">golang, concurrent, shared memory, message pass</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/memory-management-stack/" rel="tag">memory management, stack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/microservice-Load-balancing-Consul-Fabio-Golang-Cloud-Native-Docker/" rel="tag">microservice, Load balancing, Consul, Fabio Golang, Cloud-Native, Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/microservice-service-registration-service-discovery-Consul-Golang-Cloud-Native-Docker/" rel="tag">microservice, service registration, service discovery, Consul, Golang, Cloud-Native, Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/operating-system-xv6-Unix/" rel="tag">operating system, xv6, Unix</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/programming-c-array-pointer/" rel="tag">programming c, array, pointer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/public-key-man-in-the-middle-certificate/" rel="tag">public key, man-in-the-middle, certificate</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Best-practice/" style="font-size: 10px;">Best practice,</a> <a href="/tags/Fabio-Golang-Source-code/" style="font-size: 10px;">Fabio, Golang, Source code</a> <a href="/tags/Golang-bufio-bytes-buffer/" style="font-size: 10px;">Golang, bufio, bytes, buffer</a> <a href="/tags/Golang-package-workspace-vendor/" style="font-size: 10px;">Golang, package, workspace, vendor</a> <a href="/tags/HTTP-protocol-Golang-TCP-socket/" style="font-size: 10px;">HTTP protocol, Golang, TCP, socket</a> <a href="/tags/HTTP-system-call-Linux-Golang/" style="font-size: 10px;">HTTP, system call, Linux, Golang</a> <a href="/tags/HTTP-1-1-concurrent/" style="font-size: 10px;">HTTP/1.1, concurrent</a> <a href="/tags/HTTP-1-1-persistent-connection-keep-alive-TCP-netstat-tcpdump-Golang-connection-pool/" style="font-size: 10px;">HTTP/1.1, persistent connection, keep-alive, TCP, netstat, tcpdump, Golang, connection pool</a> <a href="/tags/HTTPS-TLS-handshake-SSL-TLS/" style="font-size: 10px;">HTTPS, TLS handshake, SSL/TLS</a> <a href="/tags/Linux-system-programming-Windows-Subsystem-for-Linux/" style="font-size: 10px;">Linux, system programming, Windows Subsystem for Linux</a> <a href="/tags/TCP-IP/" style="font-size: 10px;">TCP, IP</a> <a href="/tags/apt-Ubuntu-Linux-package-management/" style="font-size: 10px;">apt, Ubuntu, Linux, package management</a> <a href="/tags/certificate-digital-signature-hashing/" style="font-size: 10px;">certificate, digital signature, hashing</a> <a href="/tags/digital-signature-hash-function/" style="font-size: 20px;">digital signature, hash function</a> <a href="/tags/docker-c-linux/" style="font-size: 10px;">docker, c++, linux</a> <a href="/tags/golang-concurrent-shared-memory-message-pass/" style="font-size: 10px;">golang, concurrent, shared memory, message pass</a> <a href="/tags/memory-management-stack/" style="font-size: 10px;">memory management, stack</a> <a href="/tags/microservice-Load-balancing-Consul-Fabio-Golang-Cloud-Native-Docker/" style="font-size: 10px;">microservice, Load balancing, Consul, Fabio Golang, Cloud-Native, Docker</a> <a href="/tags/microservice-service-registration-service-discovery-Consul-Golang-Cloud-Native-Docker/" style="font-size: 10px;">microservice, service registration, service discovery, Consul, Golang, Cloud-Native, Docker</a> <a href="/tags/operating-system-xv6-Unix/" style="font-size: 10px;">operating system, xv6, Unix</a> <a href="/tags/programming-c-array-pointer/" style="font-size: 10px;">programming c, array, pointer</a> <a href="/tags/public-key-man-in-the-middle-certificate/" style="font-size: 10px;">public key, man-in-the-middle, certificate</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/02/07/stack-smashing-detect-in-c/">stack-smashing-detect-in-c</a>
          </li>
        
          <li>
            <a href="/2022/01/28/how-to-implement-arp-spoof/">how-to-implement-arp-spoof</a>
          </li>
        
          <li>
            <a href="/2022/01/20/extern-in-c/">extern-in-c</a>
          </li>
        
          <li>
            <a href="/2022/01/12/md5-implementation/">md5-implementation</a>
          </li>
        
          <li>
            <a href="/2021/12/24/how-traceroute-works/">how-traceroute-works</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Chris Bao<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>